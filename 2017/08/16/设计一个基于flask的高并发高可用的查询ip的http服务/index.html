

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" href="/img/android-chrome-192x192.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Suncle Chen">
  <meta name="keywords" content="">
  
    <meta name="description" content="结构设计基础架构为flask+gunicorn+负载均衡，负载均衡分为阿里云硬件负载均衡服务和软负载nginx。gunicorn使用supervisor进行管理。 使用nginx软件负载结构图  使用阿里云硬件负载均衡服务结构图  因为flask app需要在内存中保存ip树以及国家、省份、城市相关的字典，因此占用内存较高。gunicorn的1个worker需要占用300M内存，nginx的4个w">
<meta property="og:type" content="article">
<meta property="og:title" content="设计一个基于flask的高并发高可用的查询ip的http服务">
<meta property="og:url" content="http://example.com/2017/08/16/%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8Eflask%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E6%9F%A5%E8%AF%A2ip%E7%9A%84http%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="Suncle&#39;s Blog">
<meta property="og:description" content="结构设计基础架构为flask+gunicorn+负载均衡，负载均衡分为阿里云硬件负载均衡服务和软负载nginx。gunicorn使用supervisor进行管理。 使用nginx软件负载结构图  使用阿里云硬件负载均衡服务结构图  因为flask app需要在内存中保存ip树以及国家、省份、城市相关的字典，因此占用内存较高。gunicorn的1个worker需要占用300M内存，nginx的4个w">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8nginx%E8%BD%AF%E4%BB%B6%E8%B4%9F%E8%BD%BD%E7%BB%93%E6%9E%84%E5%9B%BE.jpg">
<meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91%E7%A1%AC%E4%BB%B6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E7%BB%93%E6%9E%84%E5%9B%BE.jpg">
<meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeterjmeter%E4%BD%BF%E7%94%A8%E6%95%B4%E7%90%86xmind.jpg">
<meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeter/ip_query_jmeter.jpg">
<meta property="article:published_time" content="2017-08-16T12:17:13.000Z">
<meta property="article:modified_time" content="2022-08-25T03:50:43.416Z">
<meta property="article:author" content="Suncle Chen">
<meta property="article:tag" content="flask">
<meta property="article:tag" content="http">
<meta property="article:tag" content="高并发">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8nginx%E8%BD%AF%E4%BB%B6%E8%B4%9F%E8%BD%BD%E7%BB%93%E6%9E%84%E5%9B%BE.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>设计一个基于flask的高并发高可用的查询ip的http服务 - Suncle&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":"41fc030db57d5570dd22f78997dc4a7e","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Suncle's Blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 60vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Suncle&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/newsletter/">
                <i class="iconfont icon-mail-fill"></i>
                周刊
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                更多
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/">
                    <i class="iconfont icon-category-fill"></i>
                    分类
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/tags/">
                    <i class="iconfont icon-tags-fill"></i>
                    标签
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/atom.xml">
                    <i class="iconfont icon-rss-fill"></i>
                    RSS
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/suncle-banner.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">设计一个基于flask的高并发高可用的查询ip的http服务</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2017-08-16 20:17" pubdate>
          2017年8月16日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          15k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          129 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="python"
        id="heading-23eeeb4347bdd26bfc6b7ee9a3b755dd" role="tab" data-toggle="collapse" href="#collapse-23eeeb4347bdd26bfc6b7ee9a3b755dd"
        aria-expanded="true"
      >
        python
        <span class="list-group-count">(32)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-23eeeb4347bdd26bfc6b7ee9a3b755dd"
           role="tabpanel" aria-labelledby="heading-23eeeb4347bdd26bfc6b7ee9a3b755dd">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2018/02/06/python-google-protocol-buffer/" title="Python Google Protocol Buffer"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python Google Protocol Buffer</span>
        </a>
      
    
      
      
        <a href="/2017/02/13/python-io/" title="Python IO"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python IO</span>
        </a>
      
    
      
      
        <a href="/2017/04/07/python-wsgi%E6%8E%A5%E5%8F%A3/" title="Python-WSGI接口"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python-WSGI接口</span>
        </a>
      
    
      
      
        <a href="/2017/04/14/python-pymysql/" title="Python-pymysql"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python-pymysql</span>
        </a>
      
    
      
      
        <a href="/2017/01/07/python%E5%87%BD%E6%95%B0/" title="Python函数"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python函数</span>
        </a>
      
    
      
      
        <a href="/2016/09/05/python%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E5%8F%8A%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/" title="Python函数定义及参数详解"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python函数定义及参数详解</span>
        </a>
      
    
      
      
        <a href="/2017/11/14/python%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" title="Python单元测试"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python单元测试</span>
        </a>
      
    
      
      
        <a href="/2016/09/02/python%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-list-tuple-dict-set/" title="Python基本数据类型-list-tuple-dict-set"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python基本数据类型-list-tuple-dict-set</span>
        </a>
      
    
      
      
        <a href="/2017/03/23/python%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="Python多线程"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python多线程</span>
        </a>
      
    
      
      
        <a href="/2016/08/30/python%E5%AD%97%E7%AC%A6%E4%B8%B2/" title="Python字符串"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python字符串</span>
        </a>
      
    
      
      
        <a href="/2017/05/22/python%E5%AE%9E%E7%8E%B0%E9%80%9A%E7%94%A8web%E6%A1%86%E6%9E%B6/" title="Python实现通用web框架"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python实现通用web框架</span>
        </a>
      
    
      
      
        <a href="/2018/03/12/python%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97%E9%9B%86%E9%94%A6/" title="Python常用模块集锦"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python常用模块集锦</span>
        </a>
      
    
      
      
        <a href="/2017/03/05/python%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" title="Python异常处理"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python异常处理</span>
        </a>
      
    
      
      
        <a href="/2017/01/12/python%E6%8B%89%E9%93%BE%E6%B3%95%E5%92%8C%E5%BC%80%E5%9C%B0%E5%9D%80%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%AD%97%E5%85%B8/" title="Python拉链法和开地址法实现字典"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python拉链法和开地址法实现字典</span>
        </a>
      
    
      
      
        <a href="/2017/03/16/python%E6%8F%8F%E8%BF%B0%E5%99%A8/" title="Python描述器"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python描述器</span>
        </a>
      
    
      
      
        <a href="/2017/09/07/python%E6%97%B6%E9%97%B4%E6%A8%A1%E5%9D%97%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93/" title="Python时间模块常用操作总结"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python时间模块常用操作总结</span>
        </a>
      
    
      
      
        <a href="/2016/12/04/python%E7%AD%94%E7%96%91%E8%A7%A3%E6%83%91/" title="Python答疑解惑"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python答疑解惑</span>
        </a>
      
    
      
      
        <a href="/2017/03/24/python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" title="Python网络编程"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python网络编程</span>
        </a>
      
    
      
      
        <a href="/2017/02/15/python%E8%A3%85%E9%A5%B0%E5%99%A8/" title="Python装饰器"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python装饰器</span>
        </a>
      
    
      
      
        <a href="/2017/02/16/python%E8%A3%85%E9%A5%B0%E5%99%A8%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5/" title="Python装饰器实现函数动态类型检查"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python装饰器实现函数动态类型检查</span>
        </a>
      
    
      
      
        <a href="/2016/12/23/python%E8%A7%A3%E6%9E%84%E4%B8%8E%E5%B0%81%E8%A3%85/" title="Python解构与封装"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python解构与封装</span>
        </a>
      
    
      
      
        <a href="/2017/01/11/python%E8%A7%A3%E6%9E%90%E5%BC%8F/" title="Python解析式"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python解析式</span>
        </a>
      
    
      
      
        <a href="/2017/03/08/python%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80/" title="Python面向对象基础"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python面向对象基础</span>
        </a>
      
    
      
      
        <a href="/2017/03/15/python%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" title="Python面向对象的魔术方法"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Python面向对象的魔术方法</span>
        </a>
      
    
      
      
        <a href="/2017/05/10/sqlalchemy%E4%BD%BF%E7%94%A8/" title="SQLAlchemy使用"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">SQLAlchemy使用</span>
        </a>
      
    
      
      
        <a href="/2016/12/13/%E3%80%90%E5%A1%AB%E5%9D%91%E7%B3%BB%E5%88%97%E3%80%91python%E4%B9%A0%E9%A2%98%E9%9B%86/" title="【填坑系列】Python习题集"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">【填坑系列】Python习题集</span>
        </a>
      
    
      
      
        <a href="/2016/12/04/%E3%80%90%E5%A1%AB%E5%9D%91%E7%B3%BB%E5%88%97%E3%80%91python%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%80%BB%E7%9B%AE%E5%BD%95/" title="【填坑系列】Python基础知识总目录"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">【填坑系列】Python基础知识总目录</span>
        </a>
      
    
      
      
        <a href="/2017/10/31/%E4%BB%8Epython%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88%E8%8E%B7%E5%8F%96%E8%A1%8C%E5%8F%B7%E7%AD%89%E4%BF%A1%E6%81%AF/" title="从Python调用堆栈获取行号等信息"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">从Python调用堆栈获取行号等信息</span>
        </a>
      
    
      
      
        <a href="/2018/03/22/%E4%BD%BF%E7%94%A8google%E7%BF%BB%E8%AF%91api/" title="使用Google翻译Api"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">使用Google翻译Api</span>
        </a>
      
    
      
      
        <a href="/2018/04/10/%E5%BE%AE%E5%8D%9A%E7%88%AC%E5%8F%96%E7%83%AD%E6%90%9C%E6%A6%9C%E5%92%8C%E7%83%AD%E9%97%A8%E8%AF%9D%E9%A2%98/" title="微博爬取热搜榜和热门话题"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">微博爬取热搜榜和热门话题</span>
        </a>
      
    
      
      
        <a href="/2017/08/16/%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8Eflask%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E6%9F%A5%E8%AF%A2ip%E7%9A%84http%E6%9C%8D%E5%8A%A1/" title="设计一个基于flask的高并发高可用的查询ip的http服务"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">设计一个基于flask的高并发高可用的查询ip的http服务</span>
        </a>
      
    
      
      
        <a href="/2017/09/25/%E8%AF%A6%E8%A7%A3supervisor%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/" title="详解supervisor进程管理"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">详解supervisor进程管理</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">设计一个基于flask的高并发高可用的查询ip的http服务</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="结构设计"><a href="#结构设计" class="headerlink" title="结构设计"></a>结构设计</h1><p>基础架构为flask+gunicorn+负载均衡，负载均衡分为阿里云硬件负载均衡服务和软负载nginx。gunicorn使用supervisor进行管理。</p>
<p><strong>使用nginx软件负载结构图</strong></p>
<p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8nginx%E8%BD%AF%E4%BB%B6%E8%B4%9F%E8%BD%BD%E7%BB%93%E6%9E%84%E5%9B%BE.jpg" srcset="/img/loading.gif" lazyload></p>
<p><strong>使用阿里云硬件负载均衡服务结构图</strong></p>
<p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91%E7%A1%AC%E4%BB%B6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E7%BB%93%E6%9E%84%E5%9B%BE.jpg" srcset="/img/loading.gif" lazyload></p>
<p>因为flask app需要在内存中保存ip树以及国家、省份、城市相关的字典，因此占用内存较高。gunicorn的1个worker需要占用300M内存，nginx的4个worker内存占用较小（不到100M），因此占用1.3G的内存（即需要一个2G内存的服务器）。当gunicorn任意一个节点挂断或者升级时，另外一个节点仍然在使用，不会影响整体服务</p>
<span id="more"></span>

<h1 id="ip数据库"><a href="#ip数据库" class="headerlink" title="ip数据库"></a>ip数据库</h1><p>IP库(也叫IP地址数据库)，是由专业技术人员经过长时间通过多种技术手段收集而来的，并且长期有专业人员进行更新、维护、补充。</p>
<p><strong>ip数据库解析查询代码</strong></p>
<p>基于二叉查找树实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">from</span> socket <span class="hljs-keyword">import</span> inet_aton, inet_ntoa<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><br>sys.setrecursionlimit(<span class="hljs-number">1000000</span>)<br><br>_unpack_V = <span class="hljs-keyword">lambda</span> b: struct.unpack(<span class="hljs-string">&quot;&lt;L&quot;</span>, b)<br>_unpack_N = <span class="hljs-keyword">lambda</span> b: struct.unpack(<span class="hljs-string">&quot;&gt;L&quot;</span>, b)<br>_unpack_C = <span class="hljs-keyword">lambda</span> b: struct.unpack(<span class="hljs-string">&quot;B&quot;</span>, b)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">IpTree</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.ip_dict = &#123;&#125;<br>        self.country_codes = &#123;&#125;<br>        self.china_province_codes = &#123;&#125;<br>        self.china_city_codes = &#123;&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_country_codes</span>(<span class="hljs-params">self, file_name</span>):<br>        <span class="hljs-keyword">try</span>:<br>            path = os.path.abspath(file_name)<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>                    data = line.split(<span class="hljs-string">&#x27;\t&#x27;</span>)<br>                    self.country_codes[data[<span class="hljs-number">0</span>]] = data[<span class="hljs-number">1</span>]<br>                    <span class="hljs-comment"># print self.country_codes</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;cannot open file %s: %s&quot;</span> % (file, ex)<br>            <span class="hljs-built_in">print</span> ex.message<br>            exit(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_china_province_codes</span>(<span class="hljs-params">self, file_name</span>):<br>        <span class="hljs-keyword">try</span>:<br>            path = os.path.abspath(file_name)<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>                    data = line.split(<span class="hljs-string">&#x27;\t&#x27;</span>)<br>                    provinces = data[<span class="hljs-number">2</span>].split(<span class="hljs-string">&#x27;\r&#x27;</span>)<br>                    self.china_province_codes[provinces[<span class="hljs-number">0</span>]] = data[<span class="hljs-number">0</span>]<br>                    <span class="hljs-comment"># print self.china_province_codes</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;cannot open file %s: %s&quot;</span> % (file, ex)<br>            <span class="hljs-built_in">print</span> ex.message<br>            exit(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_china_city_codes</span>(<span class="hljs-params">self, file_name</span>):<br>        <span class="hljs-keyword">try</span>:<br>            path = os.path.abspath(file_name)<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>                    data = line.split(<span class="hljs-string">&#x27;\t&#x27;</span>)<br>                    cities = data[<span class="hljs-number">3</span>].split(<span class="hljs-string">&#x27;\r&#x27;</span>)<br>                    self.china_city_codes[cities[<span class="hljs-number">0</span>]] = data[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;cannot open file %s: %s&quot;</span> % (file, ex)<br>            <span class="hljs-built_in">print</span> ex.message<br>            exit(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">loadfile</span>(<span class="hljs-params">self, file_name</span>):<br>        <span class="hljs-keyword">try</span>:<br>            ipdot0 = <span class="hljs-number">254</span><br>            path = os.path.abspath(file_name)<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                local_binary0 = f.read()<br>                local_offset, = _unpack_N(local_binary0[:<span class="hljs-number">4</span>])<br>                local_binary = local_binary0[<span class="hljs-number">4</span>:local_offset]<br>                <span class="hljs-comment"># 256 nodes</span><br>                <span class="hljs-keyword">while</span> ipdot0 &gt;= <span class="hljs-number">0</span>:<br>                    middle_ip = <span class="hljs-literal">None</span><br>                    middle_content = <span class="hljs-literal">None</span><br>                    lis = []<br>                    <span class="hljs-comment"># offset</span><br>                    begin_offset = ipdot0 * <span class="hljs-number">4</span><br>                    end_offset = (ipdot0 + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span><br>                    <span class="hljs-comment"># index</span><br>                    start_index, = _unpack_V(local_binary[begin_offset:begin_offset + <span class="hljs-number">4</span>])<br>                    start_index = start_index * <span class="hljs-number">8</span> + <span class="hljs-number">1024</span><br>                    end_index, = _unpack_V(local_binary[end_offset:end_offset + <span class="hljs-number">4</span>])<br>                    end_index = end_index * <span class="hljs-number">8</span> + <span class="hljs-number">1024</span><br>                    <span class="hljs-keyword">while</span> start_index &lt; end_index:<br>                        content_offset, = _unpack_V(local_binary[start_index + <span class="hljs-number">4</span>: start_index + <span class="hljs-number">7</span>] +<br>                                                    <span class="hljs-built_in">chr</span>(<span class="hljs-number">0</span>).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>                        content_length, = _unpack_C(local_binary[start_index + <span class="hljs-number">7</span>])<br>                        content_offset = local_offset + content_offset - <span class="hljs-number">1024</span><br>                        content = local_binary0[content_offset:content_offset + content_length]<br>                        <span class="hljs-keyword">if</span> middle_content != content <span class="hljs-keyword">and</span> middle_content <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                            contents = middle_content.split(<span class="hljs-string">&#x27;\t&#x27;</span>)<br>                            lis.append((middle_ip, (contents[<span class="hljs-number">0</span>], self.lookup_country_code(contents[<span class="hljs-number">0</span>]),<br>                                                    contents[<span class="hljs-number">1</span>], self.lookup_china_province_code(contents[<span class="hljs-number">1</span>]),<br>                                                    contents[<span class="hljs-number">2</span>], self.lookup_china_city_code(contents[<span class="hljs-number">2</span>]),<br>                                                    contents[<span class="hljs-number">3</span>], contents[<span class="hljs-number">4</span>])))<br>                        middle_content, = content,<br>                        middle_ip = inet_ntoa(local_binary[start_index:start_index + <span class="hljs-number">4</span>])<br>                        start_index += <span class="hljs-number">8</span><br>                    self.ip_dict[ipdot0] = self.generate_tree(lis)<br>                    ipdot0 -= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;cannot open file %s: %s&quot;</span> % (file, ex)<br>            <span class="hljs-built_in">print</span> ex.message<br>            exit(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup_country</span>(<span class="hljs-params">self, country_code</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">for</span> item_country, item_country_code <span class="hljs-keyword">in</span> self.country_codes.items():<br>                <span class="hljs-keyword">if</span> country_code == item_country_code:<br>                    <span class="hljs-keyword">return</span> item_country, item_country_code<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span>, <span class="hljs-string">&#x27;None&#x27;</span><br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span>, <span class="hljs-string">&#x27;None&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup_country_code</span>(<span class="hljs-params">self, country</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> self.country_codes[country]<br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup_china_province</span>(<span class="hljs-params">self, province_code</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">for</span> item_province, item_province_code, <span class="hljs-keyword">in</span> self.china_province_codes.items():<br>                <span class="hljs-keyword">if</span> province_code == item_province_code:<br>                    <span class="hljs-keyword">return</span> item_province, item_province_code<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span>, <span class="hljs-string">&#x27;None&#x27;</span><br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span>, <span class="hljs-string">&#x27;None&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup_china_province_code</span>(<span class="hljs-params">self, province</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> self.china_province_codes[province.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)]<br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup_china_city</span>(<span class="hljs-params">self, city_code</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">for</span> item_city, item_city_code <span class="hljs-keyword">in</span> self.china_city_codes.items():<br>                <span class="hljs-keyword">if</span> city_code == item_city_code:<br>                    <span class="hljs-keyword">return</span> item_city, item_city_code<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span>, <span class="hljs-string">&#x27;None&#x27;</span><br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span>, <span class="hljs-string">&#x27;None&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup_china_city_code</span>(<span class="hljs-params">self, city</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> self.china_city_codes[city]<br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;None&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup</span>(<span class="hljs-params">self, ip</span>):<br>        ipdot = ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        ipdot0 = <span class="hljs-built_in">int</span>(ipdot[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">if</span> ipdot0 &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> ipdot0 &gt; <span class="hljs-number">255</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(ipdot) != <span class="hljs-number">4</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">try</span>:<br>            d = self.ip_dict[<span class="hljs-built_in">int</span>(ipdot[<span class="hljs-number">0</span>])]<br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> d <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> self.lookup1(inet_aton(ip), d)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup1</span>(<span class="hljs-params">self, net_ip, (<span class="hljs-params">net_ip1, content, lefts, rights</span>)</span>):<br>        <span class="hljs-keyword">if</span> net_ip &lt; net_ip1:<br>            <span class="hljs-keyword">if</span> lefts <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">return</span> content<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> self.lookup1(net_ip, lefts)<br>        <span class="hljs-keyword">elif</span> net_ip &gt; net_ip1:<br>            <span class="hljs-keyword">if</span> rights <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">return</span> content<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> self.lookup1(net_ip, rights)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> content<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_tree</span>(<span class="hljs-params">self, ip_list</span>):<br>        length = <span class="hljs-built_in">len</span>(ip_list)<br>        <span class="hljs-keyword">if</span> length &gt; <span class="hljs-number">1</span>:<br>            lefts = ip_list[:length / <span class="hljs-number">2</span>]<br>            rights = ip_list[length / <span class="hljs-number">2</span>:]<br>            (ip, content) = lefts[length / <span class="hljs-number">2</span> - <span class="hljs-number">1</span>]<br>            <span class="hljs-keyword">return</span> inet_aton(ip), content, self.generate_tree(lefts), self.generate_tree(rights)<br>        <span class="hljs-keyword">elif</span> length == <span class="hljs-number">1</span>:<br>            (ip, content) = ip_list[<span class="hljs-number">0</span>]<br>            <span class="hljs-keyword">return</span> inet_aton(ip), content, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">import</span> sys<br><br>    reload(sys)<br>    sys.setdefaultencoding(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    ip_tree = IpTree()<br>    ip_tree.load_country_codes(<span class="hljs-string">&quot;doc/country_list.txt&quot;</span>)<br>    ip_tree.load_china_province_codes(<span class="hljs-string">&quot;doc/china_province_code.txt&quot;</span>)<br>    ip_tree.load_china_city_codes(<span class="hljs-string">&quot;doc/china_city_code.txt&quot;</span>)<br>    ip_tree.loadfile(<span class="hljs-string">&quot;doc/mydata4vipday2.dat&quot;</span>)<br>    <span class="hljs-built_in">print</span> ip_tree.lookup(<span class="hljs-string">&#x27;123.12.23.45&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h1 id="http请求"><a href="#http请求" class="headerlink" title="http请求"></a>http请求</h1><p>提供ip查询服务的GET请求和POST请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@ip_app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/ip_query&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ip_query</span>():<br>    <span class="hljs-keyword">try</span>:<br>        ip = request.json[<span class="hljs-string">&#x27;ip&#x27;</span>]<br>    <span class="hljs-keyword">except</span> KeyError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;bad request: no key ip in your request json body. &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(e), status_code=<span class="hljs-number">400</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_ip(ip):<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;&#123;&#125; is not a ip&#x27;</span>.<span class="hljs-built_in">format</span>(ip), status_code=<span class="hljs-number">400</span>)<br>    <span class="hljs-keyword">try</span>:<br>        res = ip_tree.lookup(ip)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;internal error: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(e), status_code=<span class="hljs-number">500</span>)<br>    <span class="hljs-keyword">if</span> res <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> jsonify(res)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;no ip info in ip db for ip: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(ip), status_code=<span class="hljs-number">501</span>)<br><br><br><span class="hljs-meta">@ip_app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/ip_query&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ip_query_get</span>():<br>    <span class="hljs-keyword">try</span>:<br>        ip = request.values.get(<span class="hljs-string">&#x27;ip&#x27;</span>)<br>    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;bad request: no param ip in your request. &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(e), status_code=<span class="hljs-number">400</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_ip(ip):<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;&#123;&#125; is not a ip&#x27;</span>.<span class="hljs-built_in">format</span>(ip), status_code=<span class="hljs-number">400</span>)<br>    <span class="hljs-keyword">try</span>:<br>        res = ip_tree.lookup(ip)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;internal error: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(e), status_code=<span class="hljs-number">500</span>)<br>    <span class="hljs-keyword">if</span> res <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> jsonify(res)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> InvalidUsage(<span class="hljs-string">&#x27;no ip info in ip db for ip: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(ip), status_code=<span class="hljs-number">501</span>)<br></code></pre></td></tr></table></figure>

<p>POST请求需要在请求体中包含类似下面的json字段</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;ip&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;165.118.213.9&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>GET请求的形式如：<a target="_blank" rel="noopener" href="http://127.0.0.1:5000/api/ip_query?ip=165.118.213.9">http://127.0.0.1:5000/api/ip_query?ip=165.118.213.9</a></p>
<h1 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h1><p><strong>安装依赖库</strong></p>
<p>依赖的库requirements.txt如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">certifi</span>==<span class="hljs-number">2017.7</span>.<span class="hljs-number">27.1</span><br><span class="hljs-attr">chardet</span>==<span class="hljs-number">3.0</span>.<span class="hljs-number">4</span><br><span class="hljs-attr">click</span>==<span class="hljs-number">6.7</span><br><span class="hljs-attr">Flask</span>==<span class="hljs-number">0.12</span>.<span class="hljs-number">2</span><br><span class="hljs-attr">gevent</span>==<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span><br><span class="hljs-attr">greenlet</span>==<span class="hljs-number">0.4</span>.<span class="hljs-number">12</span><br><span class="hljs-attr">gunicorn</span>==<span class="hljs-number">19.7</span>.<span class="hljs-number">1</span><br><span class="hljs-attr">idna</span>==<span class="hljs-number">2.5</span><br><span class="hljs-attr">itsdangerous</span>==<span class="hljs-number">0.24</span><br><span class="hljs-attr">Jinja2</span>==<span class="hljs-number">2.9</span>.<span class="hljs-number">6</span><br><span class="hljs-attr">locustio</span>==<span class="hljs-number">0.7</span>.<span class="hljs-number">5</span><br><span class="hljs-attr">MarkupSafe</span>==<span class="hljs-number">1.0</span><br><span class="hljs-attr">meld3</span>==<span class="hljs-number">1.0</span>.<span class="hljs-number">2</span><br><span class="hljs-attr">msgpack-python</span>==<span class="hljs-number">0.4</span>.<span class="hljs-number">8</span><br><span class="hljs-attr">requests</span>==<span class="hljs-number">2.18</span>.<span class="hljs-number">3</span><br><span class="hljs-attr">supervisor</span>==<span class="hljs-number">3.3</span>.<span class="hljs-number">3</span><br><span class="hljs-attr">urllib3</span>==<span class="hljs-number">1.22</span><br><span class="hljs-attr">Werkzeug</span>==<span class="hljs-number">0.12</span>.<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>安装方法：<code>pip install -r requirements.txt</code></p>
<p><strong>配置supervisor</strong></p>
<p><code>vim /etc/supervisor/conf.d/ip_query_http_service.conf</code>，内容如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[program:ip_query_http_service]</span><br><span class="hljs-attr">directory</span> = /root/qk_python/ip_query<br><span class="hljs-attr">command</span> = gunicorn -w10 -b0.<span class="hljs-number">0.0</span>.<span class="hljs-number">0</span>:<span class="hljs-number">8080</span> ip_query_app:ip_app --worker-class gevent<br><span class="hljs-attr">autostart</span> = <span class="hljs-literal">true</span><br><span class="hljs-attr">startsecs</span> = <span class="hljs-number">5</span><br><span class="hljs-attr">autorestart</span> = <span class="hljs-literal">true</span><br><span class="hljs-attr">startretries</span> = <span class="hljs-number">3</span><br><span class="hljs-attr">user</span> = root<br><span class="hljs-attr">stdout_logfile</span>=/root/qk_python/ip_query/log/gunicorn.log<br><span class="hljs-attr">stderr_logfile</span>=/root/qk_python/ip_query/log/gunicorn.err<br></code></pre></td></tr></table></figure>

<p>内容添加完成之后，需要创建stdout_logfile和stderr_logfile这两个目录，否则supervisor启动会报错。然后更新supervisor启动ip_query_http_service进程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动supervisor</span><br>supervisord -c /etc/supervisor/supervisord.conf	<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新supervisor服务</span><br>supervisorctl update<br></code></pre></td></tr></table></figure>

<p>关于supervisor的常用操作参见最后面的参考资料。</p>
<p><strong>安装nginx</strong></p>
<p>如果是软负载的形式需要安装nginx，编译安装nginx的方法参见最后面的参考资料。</p>
<p><strong>配置nginx</strong></p>
<p><code>vim /usr/local/nginx/nginx.conf</code>，修改配置文件内容如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-comment">#nginx进程数，建议设置为等于CPU总核心数。</span><br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">4</span>;<br><span class="hljs-comment">#error_log  logs/error.log;</span><br><span class="hljs-comment">#error_log  logs/error.log  notice;</span><br><span class="hljs-comment">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</span><br><span class="hljs-attribute">error_log</span>  logs/<span class="hljs-literal">error</span>.log  <span class="hljs-literal">info</span>;<br><span class="hljs-comment">#进程文件</span><br><span class="hljs-attribute">pid</span>        logs/nginx.pid;<br><span class="hljs-comment">#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。</span><br><span class="hljs-attribute">worker_rlimit_nofile</span> <span class="hljs-number">65535</span>;<br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-comment">#参考事件模型 linux 下使用epoll</span><br>    <span class="hljs-attribute">use</span> <span class="hljs-literal">epoll</span>;<br>    <span class="hljs-comment">#单个进程最大连接数（最大连接数=连接数*进程数）</span><br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">65535</span>;<br>&#125;<br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br>    <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] &quot;<span class="hljs-variable">$request</span>&quot; &#x27;</span><br>    <span class="hljs-string">&#x27;<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> &quot;<span class="hljs-variable">$http_referer</span>&quot; &#x27;</span><br>    <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$http_user_agent</span>&quot; &quot;<span class="hljs-variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;<br>    <span class="hljs-attribute">access_log</span>  logs/access.log  main;<br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#keepalive_timeout  0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br>    <span class="hljs-attribute">tcp_nopush</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#防止网络阻塞</span><br>    <span class="hljs-attribute">tcp_nodelay</span> <span class="hljs-literal">on</span>; <span class="hljs-comment">#防止网络阻塞</span><br>    <span class="hljs-comment">#gzip  on;</span><br>    <span class="hljs-section">server</span> &#123;<br>		<span class="hljs-comment">#这里配置衔接服务提供的代理端口.</span><br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">9000</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br>        <span class="hljs-comment">#charset koi8-r;</span><br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-comment">#            root   html;</span><br>            <span class="hljs-comment">#            index  index.html index.htm;</span><br>            <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:8000;<br>            <span class="hljs-attribute">proxy_redirect</span> <span class="hljs-literal">off</span>;<br>            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>            <span class="hljs-comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br>            <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;<br>            <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">10m</span>; <span class="hljs-comment">#允许客户端请求的最大单文件字节数</span><br>            <span class="hljs-attribute">client_body_buffer_size</span> <span class="hljs-number">128k</span>; <span class="hljs-comment">#缓冲区代理缓冲用户端请求的最大字节数，</span><br>            <span class="hljs-attribute">proxy_buffer_size</span> <span class="hljs-number">4k</span>; <span class="hljs-comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br>            <span class="hljs-attribute">proxy_temp_file_write_size</span> <span class="hljs-number">64k</span>;       <span class="hljs-comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br>        &#125;<br><br>        <span class="hljs-comment">#error_page  404              /404.html;</span><br>        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-section">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;       <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h1><p>做压力测试，选择正确的工具是前提。以下工具中，jmeter运行在windows机器较多，其他工具建议都运行在<code>*nix</code>机器上。</p>
<h2 id="压力测试工具选择"><a href="#压力测试工具选择" class="headerlink" title="压力测试工具选择"></a>压力测试工具选择</h2><table>
<thead>
<tr>
<th>工具名称</th>
<th>优缺点</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>ApacheBench(ab)</td>
<td>命令使用简单，效率高，统计信息完善，施压机器内存压力小</td>
<td>推荐</td>
</tr>
<tr>
<td>locust</td>
<td>python编写，效率低，受限于GIL，需要编写python测试脚本</td>
<td>不推荐</td>
</tr>
<tr>
<td>wrk</td>
<td>命令使用简单，效率高，统计信息精炼，坑少，少报错</td>
<td>最推荐</td>
</tr>
<tr>
<td>jmeter</td>
<td>基于java，Apache开源，图形化界面，操作简便</td>
<td>推荐</td>
</tr>
<tr>
<td>webbench</td>
<td>使用简单，但是不支持POST请求</td>
<td>一般</td>
</tr>
<tr>
<td>tsung</td>
<td>erlang编写，配置模板较多，较复杂</td>
<td>不推荐</td>
</tr>
</tbody></table>
<p>上述六种工具全部亲身使用过，下面选择ab、wrk、jmeter三种工具简单说明安装使用方法，其他工具的使用方法如有需要，自行google</p>
<h3 id="ab"><a href="#ab" class="headerlink" title="ab"></a>ab</h3><p><strong>安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt-get install apache2-utils <br></code></pre></td></tr></table></figure>

<p><strong>常见options</strong></p>
<table>
<thead>
<tr>
<th>option</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-r</td>
<td>当接收到socket错误的时候ab不退出</td>
</tr>
<tr>
<td>-t</td>
<td>发送请求的最长时间</td>
</tr>
<tr>
<td>-c</td>
<td>并发数，一次构造的请求数量</td>
</tr>
<tr>
<td>-n</td>
<td>发送的请求数量</td>
</tr>
<tr>
<td>-p</td>
<td>postfile，指定包含post数据的文件</td>
</tr>
<tr>
<td>-T</td>
<td>content-type,指定post和put发送请求时请求体的类型</td>
</tr>
</tbody></table>
<p><strong>使用</strong></p>
<p>测试GET请求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ab -r -t 120 -c 5000 http://127.0.0.1:8080/api/ip_query?ip=165.118.213.9<br></code></pre></td></tr></table></figure>

<p>测试POST请求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ab -r -t 120 -c 5000 -p /tmp/post_data.txt -T &#x27;application/json&#x27; http://127.0.0.1:8080/api/ip_query<br></code></pre></td></tr></table></figure>

<p>其中<code>/tmp/post_data.txt</code>文件的内容为待发送的-T指定格式的数据，在此处为json格式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;ip&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;125.118.213.9&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="wrk"><a href="#wrk" class="headerlink" title="wrk"></a>wrk</h3><p><a target="_blank" rel="noopener" href="http://www.restran.net/2016/09/27/wrk-http-benchmark/">http://www.restran.net/2016/09/27/wrk-http-benchmark/</a></p>
<p><strong>安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt-get install libssl-dev<br>git clone https://github.com/wg/wrk.git<br>cd wrk<br>make<br>cp wrk /usr/sbin<br></code></pre></td></tr></table></figure>

<p><strong>常见options</strong></p>
<table>
<thead>
<tr>
<th>option</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-c</td>
<td>打开的连接数，即并发数</td>
</tr>
<tr>
<td>-d</td>
<td>压力测试时间：发送请求的最长时间</td>
</tr>
<tr>
<td>-t</td>
<td>施压机器使用的线程数量</td>
</tr>
<tr>
<td>-s</td>
<td>指定要加载的lua脚本</td>
</tr>
<tr>
<td>–latency</td>
<td>打印延迟统计信息</td>
</tr>
</tbody></table>
<p><strong>使用</strong></p>
<p>测试GET请求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wrk -t10 -c5000 -d120s --latency http://127.0.0.1:8080/api/ip_query?ip=165.118.213.9<br></code></pre></td></tr></table></figure>

<p>测试POST请求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wrk -t50 -c5000 -d120s --latency -s /tmp/wrk_post.lua http://127.0.0.1:8080<br></code></pre></td></tr></table></figure>

<p>其中<code>/tmp/wrk_post.lua</code>文件的内容为待加载的lua脚本，指定post的path，header，body</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua">request = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span><br>  <span class="hljs-built_in">path</span> = <span class="hljs-string">&quot;/api/ip_query&quot;</span><br>  wrk.headers[<span class="hljs-string">&quot;Content-Type&quot;</span>] = <span class="hljs-string">&quot;application/json&quot;</span><br>  wrk.body = <span class="hljs-string">&quot;&#123;\&quot;ip\&quot;:\&quot;125.118.213.9\&quot;&#125;&quot;</span><br>  <span class="hljs-keyword">return</span> wrk.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-built_in">path</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h3 id="jmeter"><a href="#jmeter" class="headerlink" title="jmeter"></a>jmeter</h3><p><strong>安装</strong></p>
<p>安装jmeter前需要先安装jdk1.8。然后在Apache官网可以下载jmeter，<a target="_blank" rel="noopener" href="http://archive.apache.org/dist/jmeter/binaries/">点此下载</a></p>
<p><strong>使用</strong></p>
<p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeterjmeter%E4%BD%BF%E7%94%A8%E6%95%B4%E7%90%86xmind.jpg" srcset="/img/loading.gif" lazyload alt="xmind-jmeter"></p>
<p>以上图片来自一个测试大牛，非常详细，完整的xmind文件下载见：<a target="_blank" rel="noopener" href="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/file/xmind/jmeter/jmeter.xmind">jmeter-张蓓.xmind</a></p>
<p>jmeter的入门级使用也可以参考最后面的参考资料部分：<strong>使用Apache Jmeter进行并发压力测试</strong></p>
<h2 id="压力测试结果分析"><a href="#压力测试结果分析" class="headerlink" title="压力测试结果分析"></a>压力测试结果分析</h2><p><strong>wrk GET请求压测结果</strong></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">root</span>@ubuntu:/tmp# wrk -t10 -c5000 -d60s --latency http://<span class="hljs-number">127.0.0.1:8080</span>/api/ip_query?ip=<span class="hljs-number">165.118.213.9</span><br><span class="hljs-attribute">Running</span> <span class="hljs-number">1</span>m test @ http://<span class="hljs-number">127.0.0.1:8080</span>/api/ip_query?ip=<span class="hljs-number">165.118.213.9</span><br>  <span class="hljs-attribute">10</span> threads and <span class="hljs-number">5000</span> connections<br>  <span class="hljs-attribute">Thread</span> Stats   Avg      Stdev     Max   +/- Stdev<br>    <span class="hljs-attribute">Latency</span>   <span class="hljs-number">897</span>.<span class="hljs-number">19</span>ms  <span class="hljs-number">322</span>.<span class="hljs-number">83</span>ms   <span class="hljs-number">1</span>.<span class="hljs-number">99</span>s    <span class="hljs-number">70</span>.<span class="hljs-number">52</span>%<br>    <span class="hljs-attribute">Req</span>/Sec   <span class="hljs-number">318</span>.<span class="hljs-number">80</span>    <span class="hljs-number">206</span>.<span class="hljs-number">03</span>     <span class="hljs-number">2</span>.<span class="hljs-number">14</span>k    <span class="hljs-number">68</span>.<span class="hljs-number">84</span>%<br>  <span class="hljs-attribute">Latency</span> Distribution<br>     <span class="hljs-attribute">50</span>%  <span class="hljs-number">915</span>.<span class="hljs-number">29</span>ms<br>     <span class="hljs-attribute">75</span>%    <span class="hljs-number">1</span>.<span class="hljs-number">11</span>s <br>     <span class="hljs-attribute">90</span>%    <span class="hljs-number">1</span>.<span class="hljs-number">29</span>s <br>     <span class="hljs-attribute">99</span>%    <span class="hljs-number">1</span>.<span class="hljs-number">57</span>s <br>  <span class="hljs-attribute">187029</span> requests in <span class="hljs-number">1</span>.<span class="hljs-number">00</span>m, <span class="hljs-number">51</span>.<span class="hljs-number">01</span>MB read<br>  <span class="hljs-attribute">Socket</span> errors: connect <span class="hljs-number">0</span>, read <span class="hljs-number">0</span>, write <span class="hljs-number">0</span>, timeout <span class="hljs-number">38</span><br><span class="hljs-attribute">Requests</span>/sec:   <span class="hljs-number">3113</span>.<span class="hljs-number">27</span><br><span class="hljs-attribute">Transfer</span>/sec:    <span class="hljs-number">869</span>.<span class="hljs-number">53</span>KB<br></code></pre></td></tr></table></figure>

<p><strong>ab GET请求压测结果</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">root@ubuntu:/tmp#</span> <span class="hljs-string">ab</span> <span class="hljs-string">-r</span> <span class="hljs-string">-t</span> <span class="hljs-number">60</span> <span class="hljs-string">-c</span> <span class="hljs-number">5000 </span><span class="hljs-string">http://127.0.0.1:8080/api/ip_query?ip=165.118.213.9</span><br><span class="hljs-string">This</span> <span class="hljs-string">is</span> <span class="hljs-string">ApacheBench,</span> <span class="hljs-string">Version</span> <span class="hljs-number">2.3</span> <span class="hljs-string">&lt;$Revision:</span> <span class="hljs-number">1796539</span> <span class="hljs-string">$&gt;</span><br><span class="hljs-string">Copyright</span> <span class="hljs-number">1996 </span><span class="hljs-string">Adam</span> <span class="hljs-string">Twiss,</span> <span class="hljs-string">Zeus</span> <span class="hljs-string">Technology</span> <span class="hljs-string">Ltd,</span> <span class="hljs-string">http://www.zeustech.net/</span><br><span class="hljs-string">Licensed</span> <span class="hljs-string">to</span> <span class="hljs-string">The</span> <span class="hljs-string">Apache</span> <span class="hljs-string">Software</span> <span class="hljs-string">Foundation,</span> <span class="hljs-string">https://www.apache.org/</span><br><br><span class="hljs-string">Benchmarking</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">(be</span> <span class="hljs-string">patient)</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">5000 </span><span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">10000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">15000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">20000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">25000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">30000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">35000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">40000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">45000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Completed</span> <span class="hljs-number">50000</span> <span class="hljs-string">requests</span><br><span class="hljs-string">Finished</span> <span class="hljs-number">50000</span> <span class="hljs-string">requests</span><br><br><br><span class="hljs-attr">Server Software:</span>        <span class="hljs-string">gunicorn/19.7.1</span><br><span class="hljs-attr">Server Hostname:</span>        <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br><span class="hljs-attr">Server Port:</span>            <span class="hljs-number">8080</span><br><br><span class="hljs-attr">Document Path:</span>          <span class="hljs-string">/api/ip_query?ip=165.118.213.9</span><br><span class="hljs-attr">Document Length:</span>        <span class="hljs-number">128</span> <span class="hljs-string">bytes</span><br><br><span class="hljs-attr">Concurrency Level:</span>      <span class="hljs-number">5000</span><br><span class="hljs-attr">Time taken for tests:</span>   <span class="hljs-number">19.617</span> <span class="hljs-string">seconds</span><br><span class="hljs-attr">Complete requests:</span>      <span class="hljs-number">50000</span><br><span class="hljs-attr">Failed requests:</span>        <span class="hljs-number">2</span><br>   <span class="hljs-string">(Connect:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Receive:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Length:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-attr">Exceptions:</span> <span class="hljs-number">1</span><span class="hljs-string">)</span><br><span class="hljs-attr">Total transferred:</span>      <span class="hljs-number">14050000</span> <span class="hljs-string">bytes</span><br><span class="hljs-attr">HTML transferred:</span>       <span class="hljs-number">6400000</span> <span class="hljs-string">bytes</span><br><span class="hljs-attr">Requests per second:</span>    <span class="hljs-number">2548.85</span> [<span class="hljs-comment">#/sec] (mean)</span><br><span class="hljs-attr">Time per request:</span>       <span class="hljs-number">1961.668</span> [<span class="hljs-string">ms</span>] <span class="hljs-string">(mean)</span><br><span class="hljs-attr">Time per request:</span>       <span class="hljs-number">0.392</span> [<span class="hljs-string">ms</span>] <span class="hljs-string">(mean</span>, <span class="hljs-string">across</span> <span class="hljs-string">all</span> <span class="hljs-string">concurrent</span> <span class="hljs-string">requests)</span><br><span class="hljs-attr">Transfer rate:</span>          <span class="hljs-number">699.44</span> [<span class="hljs-string">Kbytes/sec</span>] <span class="hljs-string">received</span><br><br><span class="hljs-string">Connection</span> <span class="hljs-string">Times</span> <span class="hljs-string">(ms)</span><br>              <span class="hljs-string">min</span>  <span class="hljs-string">mean</span>[<span class="hljs-string">+/-sd</span>] <span class="hljs-string">median</span>   <span class="hljs-string">max</span><br><span class="hljs-attr">Connect:</span>        <span class="hljs-number">0</span>  <span class="hljs-number">597</span> <span class="hljs-number">1671.8      </span><span class="hljs-number">4</span>   <span class="hljs-number">15500</span><br><span class="hljs-attr">Processing:</span>     <span class="hljs-number">4</span>  <span class="hljs-number">224</span> <span class="hljs-number">201.4</span>    <span class="hljs-number">173</span>    <span class="hljs-number">3013</span><br><span class="hljs-attr">Waiting:</span>        <span class="hljs-number">4</span>  <span class="hljs-number">223</span> <span class="hljs-number">200.1</span>    <span class="hljs-number">172</span>    <span class="hljs-number">2873</span><br><span class="hljs-attr">Total:</span>          <span class="hljs-number">7</span>  <span class="hljs-number">821</span> <span class="hljs-number">1694.4    </span><span class="hljs-number">236</span>   <span class="hljs-number">15914</span><br><br><span class="hljs-string">Percentage</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">requests</span> <span class="hljs-string">served</span> <span class="hljs-string">within</span> <span class="hljs-string">a</span> <span class="hljs-string">certain</span> <span class="hljs-string">time</span> <span class="hljs-string">(ms)</span><br>  <span class="hljs-number">50</span><span class="hljs-string">%</span>    <span class="hljs-number">236</span><br>  <span class="hljs-number">66</span><span class="hljs-string">%</span>    <span class="hljs-number">383</span><br>  <span class="hljs-number">75</span><span class="hljs-string">%</span>   <span class="hljs-number">1049</span><br>  <span class="hljs-number">80</span><span class="hljs-string">%</span>   <span class="hljs-number">1155</span><br>  <span class="hljs-number">90</span><span class="hljs-string">%</span>   <span class="hljs-number">1476</span><br>  <span class="hljs-number">95</span><span class="hljs-string">%</span>   <span class="hljs-number">3295</span><br>  <span class="hljs-number">98</span><span class="hljs-string">%</span>   <span class="hljs-number">7347</span><br>  <span class="hljs-number">99</span><span class="hljs-string">%</span>   <span class="hljs-number">7551</span><br> <span class="hljs-number">100</span><span class="hljs-string">%</span>  <span class="hljs-number">15914</span> <span class="hljs-string">(longest</span> <span class="hljs-string">request)</span><br></code></pre></td></tr></table></figure>

<p><strong>jmeter GET请求压测结果</strong></p>
<p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeter/ip_query_jmeter.jpg" srcset="/img/loading.gif" lazyload></p>
<p><strong>结果分析</strong></p>
<p>以上三个工具的压测结果大体相同，RPS(Requests per second)大致在3000左右，此时机器配置为4核4G内存，并且gunicorn开了10个worker，内存占用3.2G。单台机器只有3000并发，对于此配置的机器来说，需要进一步分析原因。后续再弄一台机器，负载均衡后能达到5000以上才能满足使用要求。</p>
<h2 id="压力测试注意事项"><a href="#压力测试注意事项" class="headerlink" title="压力测试注意事项"></a>压力测试注意事项</h2><p><strong>文件打开数</strong></p>
<p>压力测试时对施压机器的文件打开数一般有要求，远不止1024个open files，需要增加linux系统的文件打开数，增加方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">文件打开数</span><br>ulimit -a<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改文件打开数</span><br>ulimit -n 500000<br></code></pre></td></tr></table></figure>

<p><strong>SYN洪水攻击保护</strong></p>
<p>linux系统中有一个参数：<code>/etc/sysctl.conf</code>配置文件中的<code>net.ipv4.tcp_syncookies</code>字段。这个字段值默认为1，表示系统会检测SYN洪水攻击，并开启保护。因此压测时，如果发送大量重复性数据的请求，受压机器SYN队列溢出之后启用SYN cookie，导致会有大量请求超时失败。阿里云的负载均衡是有SYN洪水攻击检测和DDos攻击检测功能的，因此在做压力测试时需要注意两点：</p>
<ul>
<li>测试时适当关闭负载均衡机器的 net.ipv4.tcp_syncookies 字段</li>
<li>造数据时应该尽量避免大量重复性数据，以免被识别为攻击。</li>
</ul>
<h1 id="gunicorn简介及调优"><a href="#gunicorn简介及调优" class="headerlink" title="gunicorn简介及调优"></a>gunicorn简介及调优</h1><p>关于gunicorn的选择可以参考测试报告：<a target="_blank" rel="noopener" href="http://www.vincentsfootprint.com/post/python-wsgi-performance-benchmark-test">Python WSGI Server 性能分析</a></p>
<p>在选定gunicorn作为WSGI server之后，需要根据机器选择相应的worker数量以及每个worker的worker-class。</p>
<p><strong>worker数量选择</strong></p>
<p>每一个worker都是作为一个单独的子进程来运行，都持有一份独立的内存数据，每增加或减少一个worker，系统内存明显的成倍数的改变。最初单台机器gunicorn开启3个worker，系统只支持1000RPS的并发。当把worker扩展为9个之后，系统支持3000RPS的并发。因此在内存足够的时候，可以适当增加worker数量。</p>
<p><strong>worker-class选择</strong></p>
<p>可以参考尾部的参考资料中的<strong>gunicorn常用settings</strong>和<strong>Gunicorn 几种 Worker class 性能测试比较</strong>这两篇文章。</p>
<p>将gunicorn启动时的worker-class从默认的sync改成gevent之后，系统RPS直接翻倍。</p>
<table>
<thead>
<tr>
<th>worker-class</th>
<th>worker数量</th>
<th>ab测试的RPS</th>
</tr>
</thead>
<tbody><tr>
<td>sync</td>
<td>3</td>
<td>573.90</td>
</tr>
<tr>
<td>gevent</td>
<td>3</td>
<td>1011.84</td>
</tr>
</tbody></table>
<p>gevent依赖：gevent &gt;&#x3D; 0.13。因此需要先使用pip安装。对应的gunicorn启动flask应用的命令需要修改为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gunicorn -w10 -b0.0.0.0:8080 ip_query_app:ip_app --worker-class gevent<br></code></pre></td></tr></table></figure>

<h1 id="改进点"><a href="#改进点" class="headerlink" title="改进点"></a>改进点</h1><p><strong>改进ip数据库准确性</strong></p>
<p>损失效率换取准确性：使用单一ip数据库会存在一些ip无法查询出结果的情况，并且国外ip一般只能精确到国家。可以平衡几家ip数据库的准确度和覆盖率，当无法查询出准确的地址信息时去查询另外几个ip数据库。</p>
<p><strong>提高单台机器并发量</strong></p>
<p>从发起请求，到WSGI服务器处理，到应用接口，到ip查询每个过程都需要单独分析每秒可执行量，进而分析系统瓶颈，从根本上提高单机并发量。</p>
<hr>
<p><strong>参考资料</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.ipip.net/download.html">全球 IPv4 地址归属地数据库(IPIP.NET 版)</a></li>
<li><a target="_blank" rel="noopener" href="http://python.jobbole.com/85008/">使用flask开发RESTful架构的api服务器端(5)–部署flask应用到nginx</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/be9dd421fb8d">python web 部署：nginx + gunicorn + supervisor + flask 部署笔记</a></li>
<li><a target="_blank" rel="noopener" href="https://suncle.me/2017/03/30/CentOS7%E4%B8%8ANginx%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/">flowsnow-nginx编译安装</a></li>
<li><a target="_blank" rel="noopener" href="http://liyangliang.me/posts/2015/06/using-supervisor/">supervisor推荐教程-使用 supervisor 管理进程</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%85%83%E6%90%9C%E5%B0%8B%E6%A8%B9">维基-二叉查找树</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/cf0853226dc6">简书-wrk压力测试post接口</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.jassassin.com/2014/04/17/tools/jmeter/">使用Apache Jmeter进行并发压力测试</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.gunicorn.org/en/stable/settings.html">gunicorn常用settings</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.wiseturtles.com/posts/gunicorn-worker-class-compare.html">Gunicorn 几种 Worker class 性能测试比较</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/python/" class="category-chain-item">python</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/flask/">#flask</a>
      
        <a href="/tags/http/">#http</a>
      
        <a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/">#高并发</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>设计一个基于flask的高并发高可用的查询ip的http服务</div>
      <div>http://example.com/2017/08/16/设计一个基于flask的高并发高可用的查询ip的http服务/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Suncle Chen</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2017年8月16日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2017/09/02/ubuntu16-04%E9%85%8D%E7%BD%AEsamba%E8%A7%A3%E5%86%B3linux%E7%9A%84svn%E4%BD%BF%E7%94%A8%E8%88%92%E9%80%82%E9%97%AE%E9%A2%98/" title="ubuntu16.04配置samba解决linux的svn使用舒适问题">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ubuntu16.04配置samba解决linux的svn使用舒适问题</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2017/08/11/erlang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1/" title="Erlang学习笔记(1)">
                        <span class="hidden-mobile">Erlang学习笔记(1)</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'suncle1993.github.io');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
