<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/android-chrome-192x192.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Suncle Chen"><meta name="keywords" content=""><meta name="description" content="结构设计基础架构为flask+gunicorn+负载均衡，负载均衡分为阿里云硬件负载均衡服务和软负载nginx。gunicorn使用supervisor进行管理。 使用nginx软件负载结构图  使用阿里云硬件负载均衡服务结构图  因为flask app需要在内存中保存ip树以及国家、省份、城市相关的字典，因此占用内存较高。gunicorn的1个worker需要占用300M内存，nginx的4个w"><meta property="og:type" content="article"><meta property="og:title" content="设计一个基于flask的高并发高可用的查询ip的http服务"><meta property="og:url" content="https://suncle.me/posts/3984252732/index.html"><meta property="og:site_name" content="Suncle"><meta property="og:description" content="结构设计基础架构为flask+gunicorn+负载均衡，负载均衡分为阿里云硬件负载均衡服务和软负载nginx。gunicorn使用supervisor进行管理。 使用nginx软件负载结构图  使用阿里云硬件负载均衡服务结构图  因为flask app需要在内存中保存ip树以及国家、省份、城市相关的字典，因此占用内存较高。gunicorn的1个worker需要占用300M内存，nginx的4个w"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8nginx%E8%BD%AF%E4%BB%B6%E8%B4%9F%E8%BD%BD%E7%BB%93%E6%9E%84%E5%9B%BE.jpg"><meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91%E7%A1%AC%E4%BB%B6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E7%BB%93%E6%9E%84%E5%9B%BE.jpg"><meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeterjmeter%E4%BD%BF%E7%94%A8%E6%95%B4%E7%90%86xmind.jpg"><meta property="og:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeter/ip_query_jmeter.jpg"><meta property="article:published_time" content="2017-08-16T12:17:13.000Z"><meta property="article:modified_time" content="2022-08-26T02:44:02.165Z"><meta property="article:author" content="Suncle Chen"><meta property="article:tag" content="flask"><meta property="article:tag" content="http"><meta property="article:tag" content="高并发"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8nginx%E8%BD%AF%E4%BB%B6%E8%B4%9F%E8%BD%BD%E7%BB%93%E6%9E%84%E5%9B%BE.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>设计一个基于flask的高并发高可用的查询ip的http服务 - Suncle</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"suncle.me",root:"/",version:"1.9.2",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:"41fc030db57d5570dd22f78997dc4a7e",google:"UA-72506112-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Suncle" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Suncle&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/categories/newsletter/"><i class="iconfont icon-mail"></i> 周刊</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" rel="external nofollow noreferrer" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 更多</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签 </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss-fill"></i> RSS</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/suncle-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">设计一个基于flask的高并发高可用的查询ip的http服务</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2017-08-16 20:17" pubdate>2017年8月16日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 14k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 117 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="python" id="heading-23eeeb4347bdd26bfc6b7ee9a3b755dd" role="tab" data-toggle="collapse" href="#collapse-23eeeb4347bdd26bfc6b7ee9a3b755dd" aria-expanded="true">python <span class="list-group-count">(32)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-23eeeb4347bdd26bfc6b7ee9a3b755dd" role="tabpanel" aria-labelledby="heading-23eeeb4347bdd26bfc6b7ee9a3b755dd"><div class="category-post-list"><a href="/posts/2114861712/" title="Python Google Protocol Buffer" class="list-group-item list-group-item-action"><span class="category-post">Python Google Protocol Buffer</span> </a><a href="/posts/3838453869/" title="Python IO" class="list-group-item list-group-item-action"><span class="category-post">Python IO</span> </a><a href="/posts/501648532/" title="Python-WSGI接口" class="list-group-item list-group-item-action"><span class="category-post">Python-WSGI接口</span> </a><a href="/posts/1140005001/" title="Python-pymysql" class="list-group-item list-group-item-action"><span class="category-post">Python-pymysql</span> </a><a href="/posts/3371524817/" title="Python函数" class="list-group-item list-group-item-action"><span class="category-post">Python函数</span> </a><a href="/posts/3373145519/" title="Python函数定义及参数详解" class="list-group-item list-group-item-action"><span class="category-post">Python函数定义及参数详解</span> </a><a href="/posts/3953642204/" title="Python单元测试" class="list-group-item list-group-item-action"><span class="category-post">Python单元测试</span> </a><a href="/posts/2639636733/" title="Python基本数据类型-list-tuple-dict-set" class="list-group-item list-group-item-action"><span class="category-post">Python基本数据类型-list-tuple-dict-set</span> </a><a href="/posts/4097981062/" title="Python多线程" class="list-group-item list-group-item-action"><span class="category-post">Python多线程</span> </a><a href="/posts/1609178714/" title="Python字符串" class="list-group-item list-group-item-action"><span class="category-post">Python字符串</span> </a><a href="/posts/3043416172/" title="Python实现通用web框架" class="list-group-item list-group-item-action"><span class="category-post">Python实现通用web框架</span> </a><a href="/posts/2568280681/" title="Python常用模块集锦" class="list-group-item list-group-item-action"><span class="category-post">Python常用模块集锦</span> </a><a href="/posts/668369792/" title="Python异常处理" class="list-group-item list-group-item-action"><span class="category-post">Python异常处理</span> </a><a href="/posts/3005931287/" title="Python拉链法和开地址法实现字典" class="list-group-item list-group-item-action"><span class="category-post">Python拉链法和开地址法实现字典</span> </a><a href="/posts/1516127351/" title="Python描述器" class="list-group-item list-group-item-action"><span class="category-post">Python描述器</span> </a><a href="/posts/2253555633/" title="Python时间模块常用操作总结" class="list-group-item list-group-item-action"><span class="category-post">Python时间模块常用操作总结</span> </a><a href="/posts/858751997/" title="Python答疑解惑" class="list-group-item list-group-item-action"><span class="category-post">Python答疑解惑</span> </a><a href="/posts/3541559492/" title="Python网络编程" class="list-group-item list-group-item-action"><span class="category-post">Python网络编程</span> </a><a href="/posts/2033838900/" title="Python装饰器" class="list-group-item list-group-item-action"><span class="category-post">Python装饰器</span> </a><a href="/posts/106366875/" title="Python装饰器实现函数动态类型检查" class="list-group-item list-group-item-action"><span class="category-post">Python装饰器实现函数动态类型检查</span> </a><a href="/posts/2276895921/" title="Python解构与封装" class="list-group-item list-group-item-action"><span class="category-post">Python解构与封装</span> </a><a href="/posts/2607945880/" title="Python解析式" class="list-group-item list-group-item-action"><span class="category-post">Python解析式</span> </a><a href="/posts/3226889536/" title="Python面向对象基础" class="list-group-item list-group-item-action"><span class="category-post">Python面向对象基础</span> </a><a href="/posts/2725239063/" title="Python面向对象的魔术方法" class="list-group-item list-group-item-action"><span class="category-post">Python面向对象的魔术方法</span> </a><a href="/posts/1924480698/" title="SQLAlchemy使用" class="list-group-item list-group-item-action"><span class="category-post">SQLAlchemy使用</span> </a><a href="/posts/599780751/" title="【填坑系列】Python习题集" class="list-group-item list-group-item-action"><span class="category-post">【填坑系列】Python习题集</span> </a><a href="/posts/2323272316/" title="【填坑系列】Python基础知识总目录" class="list-group-item list-group-item-action"><span class="category-post">【填坑系列】Python基础知识总目录</span> </a><a href="/posts/139111991/" title="从Python调用堆栈获取行号等信息" class="list-group-item list-group-item-action"><span class="category-post">从Python调用堆栈获取行号等信息</span> </a><a href="/posts/10731460/" title="使用Google翻译Api" class="list-group-item list-group-item-action"><span class="category-post">使用Google翻译Api</span> </a><a href="/posts/4100952181/" title="微博爬取热搜榜和热门话题" class="list-group-item list-group-item-action"><span class="category-post">微博爬取热搜榜和热门话题</span> </a><a href="/posts/3984252732/" title="设计一个基于flask的高并发高可用的查询ip的http服务" class="list-group-item list-group-item-action active"><span class="category-post">设计一个基于flask的高并发高可用的查询ip的http服务</span> </a><a href="/posts/1143805574/" title="详解supervisor进程管理" class="list-group-item list-group-item-action"><span class="category-post">详解supervisor进程管理</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">设计一个基于flask的高并发高可用的查询ip的http服务</h1><div class="markdown-body"><h1 id="结构设计"><a href="#结构设计" class="headerlink" title="结构设计"></a>结构设计</h1><p>基础架构为flask+gunicorn+负载均衡，负载均衡分为阿里云硬件负载均衡服务和软负载nginx。gunicorn使用supervisor进行管理。</p><p><strong>使用nginx软件负载结构图</strong></p><p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8nginx%E8%BD%AF%E4%BB%B6%E8%B4%9F%E8%BD%BD%E7%BB%93%E6%9E%84%E5%9B%BE.jpg" srcset="/img/loading.gif" lazyload></p><p><strong>使用阿里云硬件负载均衡服务结构图</strong></p><p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/python/%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91%E7%A1%AC%E4%BB%B6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E7%BB%93%E6%9E%84%E5%9B%BE.jpg" srcset="/img/loading.gif" lazyload></p><p>因为flask app需要在内存中保存ip树以及国家、省份、城市相关的字典，因此占用内存较高。gunicorn的1个worker需要占用300M内存，nginx的4个worker内存占用较小（不到100M），因此占用1.3G的内存（即需要一个2G内存的服务器）。当gunicorn任意一个节点挂断或者升级时，另外一个节点仍然在使用，不会影响整体服务</p><span id="more"></span><h1 id="ip数据库"><a href="#ip数据库" class="headerlink" title="ip数据库"></a>ip数据库</h1><p>IP库(也叫IP地址数据库)，是由专业技术人员经过长时间通过多种技术手段收集而来的，并且长期有专业人员进行更新、维护、补充。</p><p><strong>ip数据库解析查询代码</strong></p><p>基于二叉查找树实现</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> struct
<span class="token keyword">from</span> socket <span class="token keyword">import</span> inet_aton<span class="token punctuation">,</span> inet_ntoa
<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys

sys<span class="token punctuation">.</span>setrecursionlimit<span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span>

_unpack_V <span class="token operator">=</span> <span class="token keyword">lambda</span> b<span class="token punctuation">:</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"&lt;L"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
_unpack_N <span class="token operator">=</span> <span class="token keyword">lambda</span> b<span class="token punctuation">:</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">L"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
_unpack_C <span class="token operator">=</span> <span class="token keyword">lambda</span> b<span class="token punctuation">:</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">IpTree</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ip_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>country_codes <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>china_province_codes <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>china_city_codes <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">def</span> <span class="token function">load_country_codes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>country_codes<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                    <span class="token comment"># print self.country_codes</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"cannot open file %s: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span>
            <span class="token keyword">print</span> ex<span class="token punctuation">.</span>message
            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">load_china_province_codes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                    provinces <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>china_province_codes<span class="token punctuation">[</span>provinces<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    <span class="token comment"># print self.china_province_codes</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"cannot open file %s: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span>
            <span class="token keyword">print</span> ex<span class="token punctuation">.</span>message
            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">load_china_city_codes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                    cities <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>china_city_codes<span class="token punctuation">[</span>cities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"cannot open file %s: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span>
            <span class="token keyword">print</span> ex<span class="token punctuation">.</span>message
            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">loadfile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            ipdot0 <span class="token operator">=</span> <span class="token number">254</span>
            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                local_binary0 <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                local_offset<span class="token punctuation">,</span> <span class="token operator">=</span> _unpack_N<span class="token punctuation">(</span>local_binary0<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                local_binary <span class="token operator">=</span> local_binary0<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span>local_offset<span class="token punctuation">]</span>
                <span class="token comment"># 256 nodes</span>
                <span class="token keyword">while</span> ipdot0 <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    middle_ip <span class="token operator">=</span> <span class="token boolean">None</span>
                    middle_content <span class="token operator">=</span> <span class="token boolean">None</span>
                    lis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                    <span class="token comment"># offset</span>
                    begin_offset <span class="token operator">=</span> ipdot0 <span class="token operator">*</span> <span class="token number">4</span>
                    end_offset <span class="token operator">=</span> <span class="token punctuation">(</span>ipdot0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
                    <span class="token comment"># index</span>
                    start_index<span class="token punctuation">,</span> <span class="token operator">=</span> _unpack_V<span class="token punctuation">(</span>local_binary<span class="token punctuation">[</span>begin_offset<span class="token punctuation">:</span>begin_offset <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    start_index <span class="token operator">=</span> start_index <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1024</span>
                    end_index<span class="token punctuation">,</span> <span class="token operator">=</span> _unpack_V<span class="token punctuation">(</span>local_binary<span class="token punctuation">[</span>end_offset<span class="token punctuation">:</span>end_offset <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    end_index <span class="token operator">=</span> end_index <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1024</span>
                    <span class="token keyword">while</span> start_index <span class="token operator">&lt;</span> end_index<span class="token punctuation">:</span>
                        content_offset<span class="token punctuation">,</span> <span class="token operator">=</span> _unpack_V<span class="token punctuation">(</span>local_binary<span class="token punctuation">[</span>start_index <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">:</span> start_index <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+</span>
                                                    <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        content_length<span class="token punctuation">,</span> <span class="token operator">=</span> _unpack_C<span class="token punctuation">(</span>local_binary<span class="token punctuation">[</span>start_index <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        content_offset <span class="token operator">=</span> local_offset <span class="token operator">+</span> content_offset <span class="token operator">-</span> <span class="token number">1024</span>
                        content <span class="token operator">=</span> local_binary0<span class="token punctuation">[</span>content_offset<span class="token punctuation">:</span>content_offset <span class="token operator">+</span> content_length<span class="token punctuation">]</span>
                        <span class="token keyword">if</span> middle_content <span class="token operator">!=</span> content <span class="token keyword">and</span> middle_content <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                            contents <span class="token operator">=</span> middle_content<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                            lis<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>middle_ip<span class="token punctuation">,</span> <span class="token punctuation">(</span>contents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>lookup_country_code<span class="token punctuation">(</span>contents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    contents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>lookup_china_province_code<span class="token punctuation">(</span>contents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    contents<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>lookup_china_city_code<span class="token punctuation">(</span>contents<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    contents<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> contents<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        middle_content<span class="token punctuation">,</span> <span class="token operator">=</span> content<span class="token punctuation">,</span>
                        middle_ip <span class="token operator">=</span> inet_ntoa<span class="token punctuation">(</span>local_binary<span class="token punctuation">[</span>start_index<span class="token punctuation">:</span>start_index <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        start_index <span class="token operator">+=</span> <span class="token number">8</span>
                    self<span class="token punctuation">.</span>ip_dict<span class="token punctuation">[</span>ipdot0<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_tree<span class="token punctuation">(</span>lis<span class="token punctuation">)</span>
                    ipdot0 <span class="token operator">-=</span> <span class="token number">1</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"cannot open file %s: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span>
            <span class="token keyword">print</span> ex<span class="token punctuation">.</span>message
            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">lookup_country</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country_code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> item_country<span class="token punctuation">,</span> item_country_code <span class="token keyword">in</span> self<span class="token punctuation">.</span>country_codes<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> country_code <span class="token operator">==</span> item_country_code<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> item_country<span class="token punctuation">,</span> item_country_code
            <span class="token keyword">return</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'None'</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'None'</span>

    <span class="token keyword">def</span> <span class="token function">lookup_country_code</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>country_codes<span class="token punctuation">[</span>country<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'None'</span>

    <span class="token keyword">def</span> <span class="token function">lookup_china_province</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> province_code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> item_province<span class="token punctuation">,</span> item_province_code<span class="token punctuation">,</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>china_province_codes<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> province_code <span class="token operator">==</span> item_province_code<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> item_province<span class="token punctuation">,</span> item_province_code
            <span class="token keyword">return</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'None'</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'None'</span>

    <span class="token keyword">def</span> <span class="token function">lookup_china_province_code</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> province<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>china_province_codes<span class="token punctuation">[</span>province<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'None'</span>

    <span class="token keyword">def</span> <span class="token function">lookup_china_city</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> city_code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> item_city<span class="token punctuation">,</span> item_city_code <span class="token keyword">in</span> self<span class="token punctuation">.</span>china_city_codes<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> city_code <span class="token operator">==</span> item_city_code<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> item_city<span class="token punctuation">,</span> item_city_code
            <span class="token keyword">return</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'None'</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'None'</span>

    <span class="token keyword">def</span> <span class="token function">lookup_china_city_code</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>china_city_codes<span class="token punctuation">[</span>city<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'None'</span>

    <span class="token keyword">def</span> <span class="token function">lookup</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ipdot <span class="token operator">=</span> ip<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
        ipdot0 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ipdot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ipdot0 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> ipdot0 <span class="token operator">></span> <span class="token number">255</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ipdot<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            d <span class="token operator">=</span> self<span class="token punctuation">.</span>ip_dict<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>ipdot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> d <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>lookup1<span class="token punctuation">(</span>inet_aton<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">lookup1</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> net_ip<span class="token punctuation">,</span> <span class="token punctuation">(</span>net_ip1<span class="token punctuation">,</span> content<span class="token punctuation">,</span> lefts<span class="token punctuation">,</span> rights<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> net_ip <span class="token operator">&lt;</span> net_ip1<span class="token punctuation">:</span>
            <span class="token keyword">if</span> lefts <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> content
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> self<span class="token punctuation">.</span>lookup1<span class="token punctuation">(</span>net_ip<span class="token punctuation">,</span> lefts<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> net_ip <span class="token operator">></span> net_ip1<span class="token punctuation">:</span>
            <span class="token keyword">if</span> rights <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> content
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> self<span class="token punctuation">.</span>lookup1<span class="token punctuation">(</span>net_ip<span class="token punctuation">,</span> rights<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> content

    <span class="token keyword">def</span> <span class="token function">generate_tree</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ip_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ip_list<span class="token punctuation">)</span>
        <span class="token keyword">if</span> length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
            lefts <span class="token operator">=</span> ip_list<span class="token punctuation">[</span><span class="token punctuation">:</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span>
            rights <span class="token operator">=</span> ip_list<span class="token punctuation">[</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> content<span class="token punctuation">)</span> <span class="token operator">=</span> lefts<span class="token punctuation">[</span>length <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">return</span> inet_aton<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> self<span class="token punctuation">.</span>generate_tree<span class="token punctuation">(</span>lefts<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>generate_tree<span class="token punctuation">(</span>rights<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> content<span class="token punctuation">)</span> <span class="token operator">=</span> ip_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">return</span> inet_aton<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> sys

    <span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    ip_tree <span class="token operator">=</span> IpTree<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ip_tree<span class="token punctuation">.</span>load_country_codes<span class="token punctuation">(</span><span class="token string">"doc/country_list.txt"</span><span class="token punctuation">)</span>
    ip_tree<span class="token punctuation">.</span>load_china_province_codes<span class="token punctuation">(</span><span class="token string">"doc/china_province_code.txt"</span><span class="token punctuation">)</span>
    ip_tree<span class="token punctuation">.</span>load_china_city_codes<span class="token punctuation">(</span><span class="token string">"doc/china_city_code.txt"</span><span class="token punctuation">)</span>
    ip_tree<span class="token punctuation">.</span>loadfile<span class="token punctuation">(</span><span class="token string">"doc/mydata4vipday2.dat"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> ip_tree<span class="token punctuation">.</span>lookup<span class="token punctuation">(</span><span class="token string">'123.12.23.45'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h1 id="http请求"><a href="#http请求" class="headerlink" title="http请求"></a>http请求</h1><p>提供ip查询服务的GET请求和POST请求</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ip_app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/api/ip_query'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">ip_query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> KeyError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'bad request: no key ip in your request json body. &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_ip<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'&#123;&#125; is not a ip'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> ip_tree<span class="token punctuation">.</span>lookup<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'internal error: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> res <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'no ip info in ip db for ip: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">501</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@ip_app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/api/ip_query'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">ip_query_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ip'</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'bad request: no param ip in your request. &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_ip<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'&#123;&#125; is not a ip'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> ip_tree<span class="token punctuation">.</span>lookup<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'internal error: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> res <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> InvalidUsage<span class="token punctuation">(</span><span class="token string">'no ip info in ip db for ip: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> status_code<span class="token operator">=</span><span class="token number">501</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>POST请求需要在请求体中包含类似下面的json字段</p><figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
	<span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"165.118.213.9"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><p>GET请求的形式如：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://127.0.0.1:5000/api/ip_query?ip=165.118.213.9">http://127.0.0.1:5000/api/ip_query?ip=165.118.213.9</a></p><h1 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h1><p><strong>安装依赖库</strong></p><p>依赖的库requirements.txt如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token key attr-name">certifi</span><span class="token punctuation">=</span><span class="token value attr-value">=2017.7.27.1</span>
<span class="token key attr-name">chardet</span><span class="token punctuation">=</span><span class="token value attr-value">=3.0.4</span>
<span class="token key attr-name">click</span><span class="token punctuation">=</span><span class="token value attr-value">=6.7</span>
<span class="token key attr-name">Flask</span><span class="token punctuation">=</span><span class="token value attr-value">=0.12.2</span>
<span class="token key attr-name">gevent</span><span class="token punctuation">=</span><span class="token value attr-value">=1.1.1</span>
<span class="token key attr-name">greenlet</span><span class="token punctuation">=</span><span class="token value attr-value">=0.4.12</span>
<span class="token key attr-name">gunicorn</span><span class="token punctuation">=</span><span class="token value attr-value">=19.7.1</span>
<span class="token key attr-name">idna</span><span class="token punctuation">=</span><span class="token value attr-value">=2.5</span>
<span class="token key attr-name">itsdangerous</span><span class="token punctuation">=</span><span class="token value attr-value">=0.24</span>
<span class="token key attr-name">Jinja2</span><span class="token punctuation">=</span><span class="token value attr-value">=2.9.6</span>
<span class="token key attr-name">locustio</span><span class="token punctuation">=</span><span class="token value attr-value">=0.7.5</span>
<span class="token key attr-name">MarkupSafe</span><span class="token punctuation">=</span><span class="token value attr-value">=1.0</span>
<span class="token key attr-name">meld3</span><span class="token punctuation">=</span><span class="token value attr-value">=1.0.2</span>
<span class="token key attr-name">msgpack-python</span><span class="token punctuation">=</span><span class="token value attr-value">=0.4.8</span>
<span class="token key attr-name">requests</span><span class="token punctuation">=</span><span class="token value attr-value">=2.18.3</span>
<span class="token key attr-name">supervisor</span><span class="token punctuation">=</span><span class="token value attr-value">=3.3.3</span>
<span class="token key attr-name">urllib3</span><span class="token punctuation">=</span><span class="token value attr-value">=1.22</span>
<span class="token key attr-name">Werkzeug</span><span class="token punctuation">=</span><span class="token value attr-value">=0.12.2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>安装方法：<code>pip install -r requirements.txt</code></p><p><strong>配置supervisor</strong></p><p><code>vim /etc/supervisor/conf.d/ip_query_http_service.conf</code>，内容如下</p><figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">program:ip_query_http_service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">directory</span> <span class="token punctuation">=</span> <span class="token value attr-value">/root/qk_python/ip_query</span>
<span class="token key attr-name">command</span> <span class="token punctuation">=</span> <span class="token value attr-value">gunicorn -w10 -b0.0.0.0:8080 ip_query_app:ip_app --worker-class gevent</span>
<span class="token key attr-name">autostart</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span>
<span class="token key attr-name">startsecs</span> <span class="token punctuation">=</span> <span class="token value attr-value">5</span>
<span class="token key attr-name">autorestart</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span>
<span class="token key attr-name">startretries</span> <span class="token punctuation">=</span> <span class="token value attr-value">3</span>
<span class="token key attr-name">user</span> <span class="token punctuation">=</span> <span class="token value attr-value">root</span>
<span class="token key attr-name">stdout_logfile</span><span class="token punctuation">=</span><span class="token value attr-value">/root/qk_python/ip_query/log/gunicorn.log</span>
<span class="token key attr-name">stderr_logfile</span><span class="token punctuation">=</span><span class="token value attr-value">/root/qk_python/ip_query/log/gunicorn.err</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>内容添加完成之后，需要创建stdout_logfile和stderr_logfile这两个目录，否则supervisor启动会报错。然后更新supervisor启动ip_query_http_service进程。</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动supervisor</span>
supervisord <span class="token parameter variable">-c</span> /etc/supervisor/supervisord.conf	

<span class="token comment"># 更新supervisor服务</span>
supervisorctl update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>关于supervisor的常用操作参见最后面的参考资料。</p><p><strong>安装nginx</strong></p><p>如果是软负载的形式需要安装nginx，编译安装nginx的方法参见最后面的参考资料。</p><p><strong>配置nginx</strong></p><p><code>vim /usr/local/nginx/nginx.conf</code>，修改配置文件内容如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment">#user  nobody;</span>
<span class="token comment">#nginx进程数，建议设置为等于CPU总核心数。</span>
<span class="token directive"><span class="token keyword">worker_processes</span>  <span class="token number">4</span></span><span class="token punctuation">;</span>
<span class="token comment">#error_log  logs/error.log;</span>
<span class="token comment">#error_log  logs/error.log  notice;</span>
<span class="token comment">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</span>
<span class="token directive"><span class="token keyword">error_log</span>  logs/error.log  info</span><span class="token punctuation">;</span>
<span class="token comment">#进程文件</span>
<span class="token directive"><span class="token keyword">pid</span>        logs/nginx.pid</span><span class="token punctuation">;</span>
<span class="token comment">#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。</span>
<span class="token directive"><span class="token keyword">worker_rlimit_nofile</span> <span class="token number">65535</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">#参考事件模型 linux 下使用epoll</span>
    <span class="token directive"><span class="token keyword">use</span> epoll</span><span class="token punctuation">;</span>
    <span class="token comment">#单个进程最大连接数（最大连接数=连接数*进程数）</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">65535</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">include</span>       mime.types</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">default_type</span>  application/octet-stream</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">log_format</span>  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> "<span class="token variable">$request</span>" '</span>
    <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
    <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">access_log</span>  logs/access.log  main</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">sendfile</span>        <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token comment">#keepalive_timeout  0;</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">tcp_nopush</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span> <span class="token comment">#防止网络阻塞</span>
    <span class="token directive"><span class="token keyword">tcp_nodelay</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span> <span class="token comment">#防止网络阻塞</span>
    <span class="token comment">#gzip  on;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
		<span class="token comment">#这里配置衔接服务提供的代理端口.</span>
        <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">9000</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>
        <span class="token comment">#charset koi8-r;</span>
        <span class="token comment">#access_log  logs/host.access.log  main;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">#            root   html;</span>
            <span class="token comment">#            index  index.html index.htm;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8000</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">10m</span></span><span class="token punctuation">;</span> <span class="token comment">#允许客户端请求的最大单文件字节数</span>
            <span class="token directive"><span class="token keyword">client_body_buffer_size</span> <span class="token number">128k</span></span><span class="token punctuation">;</span> <span class="token comment">#缓冲区代理缓冲用户端请求的最大字节数，</span>
            <span class="token directive"><span class="token keyword">proxy_buffer_size</span> <span class="token number">4k</span></span><span class="token punctuation">;</span> <span class="token comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span>
            <span class="token directive"><span class="token keyword">proxy_temp_file_write_size</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>       <span class="token comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">#error_page  404              /404.html;</span>
        <span class="token comment"># redirect server error pages to the static page /50x.html</span>
        <span class="token comment">#</span>
        <span class="token directive"><span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> = /50x.html</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>       
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h1 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h1><p>做压力测试，选择正确的工具是前提。以下工具中，jmeter运行在windows机器较多，其他工具建议都运行在<code>*nix</code>机器上。</p><h2 id="压力测试工具选择"><a href="#压力测试工具选择" class="headerlink" title="压力测试工具选择"></a>压力测试工具选择</h2><table><thead><tr><th>工具名称</th><th>优缺点</th><th>建议</th></tr></thead><tbody><tr><td>ApacheBench(ab)</td><td>命令使用简单，效率高，统计信息完善，施压机器内存压力小</td><td>推荐</td></tr><tr><td>locust</td><td>python编写，效率低，受限于GIL，需要编写python测试脚本</td><td>不推荐</td></tr><tr><td>wrk</td><td>命令使用简单，效率高，统计信息精炼，坑少，少报错</td><td>最推荐</td></tr><tr><td>jmeter</td><td>基于java，Apache开源，图形化界面，操作简便</td><td>推荐</td></tr><tr><td>webbench</td><td>使用简单，但是不支持POST请求</td><td>一般</td></tr><tr><td>tsung</td><td>erlang编写，配置模板较多，较复杂</td><td>不推荐</td></tr></tbody></table><p>上述六种工具全部亲身使用过，下面选择ab、wrk、jmeter三种工具简单说明安装使用方法，其他工具的使用方法如有需要，自行google</p><h3 id="ab"><a href="#ab" class="headerlink" title="ab"></a>ab</h3><p><strong>安装</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> apache2-utils <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p><strong>常见options</strong></p><table><thead><tr><th>option</th><th>含义</th></tr></thead><tbody><tr><td>-r</td><td>当接收到socket错误的时候ab不退出</td></tr><tr><td>-t</td><td>发送请求的最长时间</td></tr><tr><td>-c</td><td>并发数，一次构造的请求数量</td></tr><tr><td>-n</td><td>发送的请求数量</td></tr><tr><td>-p</td><td>postfile，指定包含post数据的文件</td></tr><tr><td>-T</td><td>content-type,指定post和put发送请求时请求体的类型</td></tr></tbody></table><p><strong>使用</strong></p><p>测试GET请求</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ab <span class="token parameter variable">-r</span> <span class="token parameter variable">-t</span> <span class="token number">120</span> <span class="token parameter variable">-c</span> <span class="token number">5000</span> http://127.0.0.1:8080/api/ip_query?ip<span class="token operator">=</span><span class="token number">165.118</span>.213.9<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>测试POST请求</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ab <span class="token parameter variable">-r</span> <span class="token parameter variable">-t</span> <span class="token number">120</span> <span class="token parameter variable">-c</span> <span class="token number">5000</span> <span class="token parameter variable">-p</span> /tmp/post_data.txt <span class="token parameter variable">-T</span> <span class="token string">'application/json'</span> http://127.0.0.1:8080/api/ip_query<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>其中<code>/tmp/post_data.txt</code>文件的内容为待发送的-T指定格式的数据，在此处为json格式</p><figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"125.118.213.9"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="wrk"><a href="#wrk" class="headerlink" title="wrk"></a>wrk</h3><p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.restran.net/2016/09/27/wrk-http-benchmark/">http://www.restran.net/2016/09/27/wrk-http-benchmark/</a></p><p><strong>安装</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> libssl-dev
<span class="token function">git</span> clone https://github.com/wg/wrk.git
<span class="token builtin class-name">cd</span> wrk
<span class="token function">make</span>
<span class="token function">cp</span> wrk /usr/sbin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><strong>常见options</strong></p><table><thead><tr><th>option</th><th>含义</th></tr></thead><tbody><tr><td>-c</td><td>打开的连接数，即并发数</td></tr><tr><td>-d</td><td>压力测试时间：发送请求的最长时间</td></tr><tr><td>-t</td><td>施压机器使用的线程数量</td></tr><tr><td>-s</td><td>指定要加载的lua脚本</td></tr><tr><td>–latency</td><td>打印延迟统计信息</td></tr></tbody></table><p><strong>使用</strong></p><p>测试GET请求</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wrk <span class="token parameter variable">-t10</span> <span class="token parameter variable">-c5000</span> <span class="token parameter variable">-d120s</span> <span class="token parameter variable">--latency</span> http://127.0.0.1:8080/api/ip_query?ip<span class="token operator">=</span><span class="token number">165.118</span>.213.9<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>测试POST请求</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wrk <span class="token parameter variable">-t50</span> <span class="token parameter variable">-c5000</span> <span class="token parameter variable">-d120s</span> <span class="token parameter variable">--latency</span> <span class="token parameter variable">-s</span> /tmp/wrk_post.lua http://127.0.0.1:8080<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>其中<code>/tmp/wrk_post.lua</code>文件的内容为待加载的lua脚本，指定post的path，header，body</p><figure><div class="code-wrapper"><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">request <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  path <span class="token operator">=</span> <span class="token string">"/api/ip_query"</span>
  wrk<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"application/json"</span>
  wrk<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"&#123;\"ip\":\"125.118.213.9\"&#125;"</span>
  <span class="token keyword">return</span> wrk<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="jmeter"><a href="#jmeter" class="headerlink" title="jmeter"></a>jmeter</h3><p><strong>安装</strong></p><p>安装jmeter前需要先安装jdk1.8。然后在Apache官网可以下载jmeter，<a target="_blank" rel="noopener external nofollow noreferrer" href="http://archive.apache.org/dist/jmeter/binaries/">点此下载</a></p><p><strong>使用</strong></p><p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeterjmeter%E4%BD%BF%E7%94%A8%E6%95%B4%E7%90%86xmind.jpg" srcset="/img/loading.gif" lazyload alt="xmind-jmeter"></p><p>以上图片来自一个测试大牛，非常详细，完整的xmind文件下载见：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/file/xmind/jmeter/jmeter.xmind">jmeter-张蓓.xmind</a></p><p>jmeter的入门级使用也可以参考最后面的参考资料部分：<strong>使用Apache Jmeter进行并发压力测试</strong></p><h2 id="压力测试结果分析"><a href="#压力测试结果分析" class="headerlink" title="压力测试结果分析"></a>压力测试结果分析</h2><p><strong>wrk GET请求压测结果</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">root@ubuntu:&#x2F;tmp# wrk -t10 -c5000 -d60s --latency http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;api&#x2F;ip_query?ip&#x3D;165.118.213.9
Running 1m test @ http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;api&#x2F;ip_query?ip&#x3D;165.118.213.9
  10 threads and 5000 connections
  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev
    Latency   897.19ms  322.83ms   1.99s    70.52%
    Req&#x2F;Sec   318.80    206.03     2.14k    68.84%
  Latency Distribution
     50%  915.29ms
     75%    1.11s 
     90%    1.29s 
     99%    1.57s 
  187029 requests in 1.00m, 51.01MB read
  Socket errors: connect 0, read 0, write 0, timeout 38
Requests&#x2F;sec:   3113.27
Transfer&#x2F;sec:    869.53KB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><strong>ab GET请求压测结果</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">root@ubuntu:&#x2F;tmp# ab -r -t 60 -c 5000 http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;api&#x2F;ip_query?ip&#x3D;165.118.213.9
This is ApacheBench, Version 2.3 &lt;$Revision: 1796539 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;
Licensed to The Apache Software Foundation, https:&#x2F;&#x2F;www.apache.org&#x2F;

Benchmarking 127.0.0.1 (be patient)
Completed 5000 requests
Completed 10000 requests
Completed 15000 requests
Completed 20000 requests
Completed 25000 requests
Completed 30000 requests
Completed 35000 requests
Completed 40000 requests
Completed 45000 requests
Completed 50000 requests
Finished 50000 requests


Server Software:        gunicorn&#x2F;19.7.1
Server Hostname:        127.0.0.1
Server Port:            8080

Document Path:          &#x2F;api&#x2F;ip_query?ip&#x3D;165.118.213.9
Document Length:        128 bytes

Concurrency Level:      5000
Time taken for tests:   19.617 seconds
Complete requests:      50000
Failed requests:        2
   (Connect: 0, Receive: 0, Length: 1, Exceptions: 1)
Total transferred:      14050000 bytes
HTML transferred:       6400000 bytes
Requests per second:    2548.85 [#&#x2F;sec] (mean)
Time per request:       1961.668 [ms] (mean)
Time per request:       0.392 [ms] (mean, across all concurrent requests)
Transfer rate:          699.44 [Kbytes&#x2F;sec] received

Connection Times (ms)
              min  mean[+&#x2F;-sd] median   max
Connect:        0  597 1671.8      4   15500
Processing:     4  224 201.4    173    3013
Waiting:        4  223 200.1    172    2873
Total:          7  821 1694.4    236   15914

Percentage of the requests served within a certain time (ms)
  50%    236
  66%    383
  75%   1049
  80%   1155
  90%   1476
  95%   3295
  98%   7347
  99%   7551
 100%  15914 (longest request)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><strong>jmeter GET请求压测结果</strong></p><p><img src="https://flowsnow.oss-cn-shanghai.aliyuncs.com/history/image/jmeter/ip_query_jmeter.jpg" srcset="/img/loading.gif" lazyload></p><p><strong>结果分析</strong></p><p>以上三个工具的压测结果大体相同，RPS(Requests per second)大致在3000左右，此时机器配置为4核4G内存，并且gunicorn开了10个worker，内存占用3.2G。单台机器只有3000并发，对于此配置的机器来说，需要进一步分析原因。后续再弄一台机器，负载均衡后能达到5000以上才能满足使用要求。</p><h2 id="压力测试注意事项"><a href="#压力测试注意事项" class="headerlink" title="压力测试注意事项"></a>压力测试注意事项</h2><p><strong>文件打开数</strong></p><p>压力测试时对施压机器的文件打开数一般有要求，远不止1024个open files，需要增加linux系统的文件打开数，增加方法：</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 文件打开数</span>
<span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-a</span>
<span class="token comment"># 修改文件打开数</span>
<span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">500000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><strong>SYN洪水攻击保护</strong></p><p>linux系统中有一个参数：<code>/etc/sysctl.conf</code>配置文件中的<code>net.ipv4.tcp_syncookies</code>字段。这个字段值默认为1，表示系统会检测SYN洪水攻击，并开启保护。因此压测时，如果发送大量重复性数据的请求，受压机器SYN队列溢出之后启用SYN cookie，导致会有大量请求超时失败。阿里云的负载均衡是有SYN洪水攻击检测和DDos攻击检测功能的，因此在做压力测试时需要注意两点：</p><ul><li>测试时适当关闭负载均衡机器的 net.ipv4.tcp_syncookies 字段</li><li>造数据时应该尽量避免大量重复性数据，以免被识别为攻击。</li></ul><h1 id="gunicorn简介及调优"><a href="#gunicorn简介及调优" class="headerlink" title="gunicorn简介及调优"></a>gunicorn简介及调优</h1><p>关于gunicorn的选择可以参考测试报告：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.vincentsfootprint.com/post/python-wsgi-performance-benchmark-test">Python WSGI Server 性能分析</a></p><p>在选定gunicorn作为WSGI server之后，需要根据机器选择相应的worker数量以及每个worker的worker-class。</p><p><strong>worker数量选择</strong></p><p>每一个worker都是作为一个单独的子进程来运行，都持有一份独立的内存数据，每增加或减少一个worker，系统内存明显的成倍数的改变。最初单台机器gunicorn开启3个worker，系统只支持1000RPS的并发。当把worker扩展为9个之后，系统支持3000RPS的并发。因此在内存足够的时候，可以适当增加worker数量。</p><p><strong>worker-class选择</strong></p><p>可以参考尾部的参考资料中的<strong>gunicorn常用settings</strong>和<strong>Gunicorn 几种 Worker class 性能测试比较</strong>这两篇文章。</p><p>将gunicorn启动时的worker-class从默认的sync改成gevent之后，系统RPS直接翻倍。</p><table><thead><tr><th>worker-class</th><th>worker数量</th><th>ab测试的RPS</th></tr></thead><tbody><tr><td>sync</td><td>3</td><td>573.90</td></tr><tr><td>gevent</td><td>3</td><td>1011.84</td></tr></tbody></table><p>gevent依赖：gevent &gt;&#x3D; 0.13。因此需要先使用pip安装。对应的gunicorn启动flask应用的命令需要修改为：</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gunicorn <span class="token parameter variable">-w10</span> -b0.0.0.0:8080 ip_query_app:ip_app --worker-class gevent<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h1 id="改进点"><a href="#改进点" class="headerlink" title="改进点"></a>改进点</h1><p><strong>改进ip数据库准确性</strong></p><p>损失效率换取准确性：使用单一ip数据库会存在一些ip无法查询出结果的情况，并且国外ip一般只能精确到国家。可以平衡几家ip数据库的准确度和覆盖率，当无法查询出准确的地址信息时去查询另外几个ip数据库。</p><p><strong>提高单台机器并发量</strong></p><p>从发起请求，到WSGI服务器处理，到应用接口，到ip查询每个过程都需要单独分析每秒可执行量，进而分析系统瓶颈，从根本上提高单机并发量。</p><hr><p><strong>参考资料</strong></p><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.ipip.net/download.html">全球 IPv4 地址归属地数据库(IPIP.NET 版)</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://python.jobbole.com/85008/">使用flask开发RESTful架构的api服务器端(5)–部署flask应用到nginx</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.jianshu.com/p/be9dd421fb8d">python web 部署：nginx + gunicorn + supervisor + flask 部署笔记</a></li><li><a href="https://suncle.me/2017/03/30/CentOS7%E4%B8%8ANginx%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/">flowsnow-nginx编译安装</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://liyangliang.me/posts/2015/06/using-supervisor/">supervisor推荐教程-使用 supervisor 管理进程</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%85%83%E6%90%9C%E5%B0%8B%E6%A8%B9">维基-二叉查找树</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.jianshu.com/p/cf0853226dc6">简书-wrk压力测试post接口</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog.jassassin.com/2014/04/17/tools/jmeter/">使用Apache Jmeter进行并发压力测试</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://docs.gunicorn.org/en/stable/settings.html">gunicorn常用settings</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog.wiseturtles.com/posts/gunicorn-worker-class-compare.html">Gunicorn 几种 Worker class 性能测试比较</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/python/" class="category-chain-item">python</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/flask/">#flask</a> <a href="/tags/http/">#http</a> <a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/">#高并发</a></div></div><div class="license-box my-3"><div class="license-title"><div>设计一个基于flask的高并发高可用的查询ip的http服务</div><div>https://suncle.me/posts/3984252732/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Suncle Chen</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2017年8月16日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/posts/171915988/" title="ubuntu16.04配置samba解决linux的svn使用舒适问题"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">ubuntu16.04配置samba解决linux的svn使用舒适问题</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/3652260204/" title="Erlang学习笔记(1)"><span class="hidden-mobile">Erlang学习笔记(1)</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><script type="text/javascript">Fluid.utils.loadComments("#comments",(function(){var t=document.documentElement.getAttribute("data-user-color-scheme");t="dark"===t?"github-dark":"github-light",window.UtterancesThemeLight="github-light",window.UtterancesThemeDark="github-dark";var e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","suncle1993/suncle1993.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>