<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/android-chrome-192x192.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Suncle Chen"><meta name="keywords" content=""><meta name="description" content="多线程基础概念并行与并发  并行：同时处理多个任务，必须在多核环境下 一段时间内同时处理多个任务，单核也可以并发  并发手段  线程：内核空间的调度 进程：内核空间的调度 协程：用户空间的调度  线程可以允许程序在同一进程空间中并发运行多个操作。本次主要介绍Python标准库中的多线程模块threading。"><meta property="og:type" content="article"><meta property="og:title" content="Python多线程"><meta property="og:url" content="https://suncle.me/posts/4097981062/index.html"><meta property="og:site_name" content="Suncle"><meta property="og:description" content="多线程基础概念并行与并发  并行：同时处理多个任务，必须在多核环境下 一段时间内同时处理多个任务，单核也可以并发  并发手段  线程：内核空间的调度 进程：内核空间的调度 协程：用户空间的调度  线程可以允许程序在同一进程空间中并发运行多个操作。本次主要介绍Python标准库中的多线程模块threading。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2017-03-22T17:57:30.000Z"><meta property="article:modified_time" content="2022-08-26T02:44:02.113Z"><meta property="article:author" content="Suncle Chen"><meta property="article:tag" content="Python"><meta property="article:tag" content="多线程"><meta property="article:tag" content="threading"><meta name="twitter:card" content="summary_large_image"><meta name="referrer" content="no-referrer-when-downgrade"><title>Python多线程 - Suncle</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"suncle.me",root:"/",version:"1.9.2",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:"41fc030db57d5570dd22f78997dc4a7e",google:"UA-72506112-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Suncle" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Suncle&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/categories/newsletter/"><i class="iconfont icon-mail"></i> 周刊</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" rel="external nofollow noreferrer" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 更多</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签 </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss-fill"></i> RSS</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/suncle-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">Python多线程</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2017-03-23 01:57" pubdate>2017年3月23日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 22k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 185 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="python" id="heading-23eeeb4347bdd26bfc6b7ee9a3b755dd" role="tab" data-toggle="collapse" href="#collapse-23eeeb4347bdd26bfc6b7ee9a3b755dd" aria-expanded="true">python <span class="list-group-count">(32)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-23eeeb4347bdd26bfc6b7ee9a3b755dd" role="tabpanel" aria-labelledby="heading-23eeeb4347bdd26bfc6b7ee9a3b755dd"><div class="category-post-list"><a href="/posts/2114861712/" title="Python Google Protocol Buffer" class="list-group-item list-group-item-action"><span class="category-post">Python Google Protocol Buffer</span> </a><a href="/posts/3838453869/" title="Python IO" class="list-group-item list-group-item-action"><span class="category-post">Python IO</span> </a><a href="/posts/501648532/" title="Python-WSGI接口" class="list-group-item list-group-item-action"><span class="category-post">Python-WSGI接口</span> </a><a href="/posts/1140005001/" title="Python-pymysql" class="list-group-item list-group-item-action"><span class="category-post">Python-pymysql</span> </a><a href="/posts/3371524817/" title="Python函数" class="list-group-item list-group-item-action"><span class="category-post">Python函数</span> </a><a href="/posts/3373145519/" title="Python函数定义及参数详解" class="list-group-item list-group-item-action"><span class="category-post">Python函数定义及参数详解</span> </a><a href="/posts/3953642204/" title="Python单元测试" class="list-group-item list-group-item-action"><span class="category-post">Python单元测试</span> </a><a href="/posts/2639636733/" title="Python基本数据类型-list-tuple-dict-set" class="list-group-item list-group-item-action"><span class="category-post">Python基本数据类型-list-tuple-dict-set</span> </a><a href="/posts/4097981062/" title="Python多线程" class="list-group-item list-group-item-action active"><span class="category-post">Python多线程</span> </a><a href="/posts/1609178714/" title="Python字符串" class="list-group-item list-group-item-action"><span class="category-post">Python字符串</span> </a><a href="/posts/3043416172/" title="Python实现通用web框架" class="list-group-item list-group-item-action"><span class="category-post">Python实现通用web框架</span> </a><a href="/posts/2568280681/" title="Python常用模块集锦" class="list-group-item list-group-item-action"><span class="category-post">Python常用模块集锦</span> </a><a href="/posts/668369792/" title="Python异常处理" class="list-group-item list-group-item-action"><span class="category-post">Python异常处理</span> </a><a href="/posts/3005931287/" title="Python拉链法和开地址法实现字典" class="list-group-item list-group-item-action"><span class="category-post">Python拉链法和开地址法实现字典</span> </a><a href="/posts/1516127351/" title="Python描述器" class="list-group-item list-group-item-action"><span class="category-post">Python描述器</span> </a><a href="/posts/2253555633/" title="Python时间模块常用操作总结" class="list-group-item list-group-item-action"><span class="category-post">Python时间模块常用操作总结</span> </a><a href="/posts/858751997/" title="Python答疑解惑" class="list-group-item list-group-item-action"><span class="category-post">Python答疑解惑</span> </a><a href="/posts/3541559492/" title="Python网络编程" class="list-group-item list-group-item-action"><span class="category-post">Python网络编程</span> </a><a href="/posts/2033838900/" title="Python装饰器" class="list-group-item list-group-item-action"><span class="category-post">Python装饰器</span> </a><a href="/posts/106366875/" title="Python装饰器实现函数动态类型检查" class="list-group-item list-group-item-action"><span class="category-post">Python装饰器实现函数动态类型检查</span> </a><a href="/posts/2276895921/" title="Python解构与封装" class="list-group-item list-group-item-action"><span class="category-post">Python解构与封装</span> </a><a href="/posts/2607945880/" title="Python解析式" class="list-group-item list-group-item-action"><span class="category-post">Python解析式</span> </a><a href="/posts/3226889536/" title="Python面向对象基础" class="list-group-item list-group-item-action"><span class="category-post">Python面向对象基础</span> </a><a href="/posts/2725239063/" title="Python面向对象的魔术方法" class="list-group-item list-group-item-action"><span class="category-post">Python面向对象的魔术方法</span> </a><a href="/posts/1924480698/" title="SQLAlchemy使用" class="list-group-item list-group-item-action"><span class="category-post">SQLAlchemy使用</span> </a><a href="/posts/599780751/" title="【填坑系列】Python习题集" class="list-group-item list-group-item-action"><span class="category-post">【填坑系列】Python习题集</span> </a><a href="/posts/2323272316/" title="【填坑系列】Python基础知识总目录" class="list-group-item list-group-item-action"><span class="category-post">【填坑系列】Python基础知识总目录</span> </a><a href="/posts/139111991/" title="从Python调用堆栈获取行号等信息" class="list-group-item list-group-item-action"><span class="category-post">从Python调用堆栈获取行号等信息</span> </a><a href="/posts/10731460/" title="使用Google翻译Api" class="list-group-item list-group-item-action"><span class="category-post">使用Google翻译Api</span> </a><a href="/posts/4100952181/" title="微博爬取热搜榜和热门话题" class="list-group-item list-group-item-action"><span class="category-post">微博爬取热搜榜和热门话题</span> </a><a href="/posts/3984252732/" title="设计一个基于flask的高并发高可用的查询ip的http服务" class="list-group-item list-group-item-action"><span class="category-post">设计一个基于flask的高并发高可用的查询ip的http服务</span> </a><a href="/posts/1143805574/" title="详解supervisor进程管理" class="list-group-item list-group-item-action"><span class="category-post">详解supervisor进程管理</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Python多线程</h1><div class="markdown-body"><h1 id="多线程基础概念"><a href="#多线程基础概念" class="headerlink" title="多线程基础概念"></a>多线程基础概念</h1><p><strong>并行与并发</strong></p><ul><li>并行：同时处理多个任务，必须在多核环境下</li><li>一段时间内同时处理多个任务，单核也可以并发</li></ul><p><strong>并发手段</strong></p><ul><li>线程：内核空间的调度</li><li>进程：内核空间的调度</li><li>协程：用户空间的调度</li></ul><p>线程可以允许程序在同一进程空间中并发运行多个操作。本次主要介绍Python标准库中的多线程模块threading。</p><span id="more"></span><h1 id="threading模块"><a href="#threading模块" class="headerlink" title="threading模块"></a>threading模块</h1><h2 id="线程初始化"><a href="#线程初始化" class="headerlink" title="线程初始化"></a>线程初始化</h2><p>使用threading模块的Thread类初始化对象然后调用start方法启动线程。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 创建线程对象 target参数是一个函数， 这个函数即线程要执行的逻辑</span>
threads <span class="token operator">=</span> <span class="token punctuation">[</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> t <span class="token keyword">in</span> threads<span class="token punctuation">:</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># start 方法启动一个线程， 当这个线程的逻辑执行完毕的时候，线程自动退出, Python 没有提供主动退出线程的方法</span>

<span class="token comment"># 输出以下结果</span>
worker<span class="token operator">-</span>0worker<span class="token operator">-</span>1worker<span class="token operator">-</span>2worker<span class="token operator">-</span><span class="token number">3</span>



worker<span class="token operator">-</span><span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>初始化的五个线程的执行逻辑中的print方法打印字符串及换行符出现了随机分布，即出现了资源竞争。</p><h2 id="给线程传递参数"><a href="#给线程传递参数" class="headerlink" title="给线程传递参数"></a>给线程传递参数</h2><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>

threads <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token string">'b'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 输出</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token string">'b'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>args传递位置参数，kwargs传递关键字参数。</p><h2 id="Thread常用参数和方法"><a href="#Thread常用参数和方法" class="headerlink" title="Thread常用参数和方法"></a>Thread常用参数和方法</h2><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; help(threading.Thread)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>可以看到Thread函数的初始化方法中的参数如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">|</span>  __init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> group<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token operator">|</span>      This constructor should always be called <span class="token keyword">with</span> keyword arguments<span class="token punctuation">.</span> Arguments are<span class="token punctuation">:</span>
<span class="token operator">|</span>      
<span class="token operator">|</span>      <span class="token operator">*</span>group<span class="token operator">*</span> should be <span class="token boolean">None</span><span class="token punctuation">;</span> reserved <span class="token keyword">for</span> future extension when a ThreadGroup
<span class="token operator">|</span>      <span class="token keyword">class</span> <span class="token class-name">is</span> implemented<span class="token punctuation">.</span>
<span class="token operator">|</span>      
<span class="token operator">|</span>      <span class="token operator">*</span>target<span class="token operator">*</span> <span class="token keyword">is</span> the <span class="token builtin">callable</span> <span class="token builtin">object</span> to be invoked by the run<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">|</span>      method<span class="token punctuation">.</span> Defaults to <span class="token boolean">None</span><span class="token punctuation">,</span> meaning nothing <span class="token keyword">is</span> called<span class="token punctuation">.</span>
<span class="token operator">|</span>      
<span class="token operator">|</span>      <span class="token operator">*</span>name<span class="token operator">*</span> <span class="token keyword">is</span> the thread name<span class="token punctuation">.</span> By default<span class="token punctuation">,</span> a unique name <span class="token keyword">is</span> constructed of
<span class="token operator">|</span>      the form <span class="token string">"Thread-N"</span> where N <span class="token keyword">is</span> a small decimal number<span class="token punctuation">.</span>
<span class="token operator">|</span>      
<span class="token operator">|</span>      <span class="token operator">*</span>args<span class="token operator">*</span> <span class="token keyword">is</span> the argument <span class="token builtin">tuple</span> <span class="token keyword">for</span> the target invocation<span class="token punctuation">.</span> Defaults to <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token operator">|</span>      
<span class="token operator">|</span>      <span class="token operator">*</span>kwargs<span class="token operator">*</span> <span class="token keyword">is</span> a dictionary of keyword arguments <span class="token keyword">for</span> the target
<span class="token operator">|</span>      invocation<span class="token punctuation">.</span> Defaults to <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="name"><a href="#name" class="headerlink" title="name"></a>name</h3><p>表示线程名称，默认情况下，线程名称是<code>Thread-N</code>，N是一个较小的十进制数。我们可以传递name参数，控制线程名称。</p><p>以下会导入logging模块来显示线程的名称等详细信息</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

threads <span class="token operator">=</span> <span class="token punctuation">[</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'workerthread-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> t <span class="token keyword">in</span> threads<span class="token punctuation">:</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 输出</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">339</span> INFO <span class="token punctuation">[</span>workerthread<span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">]</span> worker<span class="token operator">-</span><span class="token number">0</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">340</span> INFO <span class="token punctuation">[</span>workerthread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> worker<span class="token operator">-</span><span class="token number">1</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">340</span> INFO <span class="token punctuation">[</span>workerthread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> worker<span class="token operator">-</span><span class="token number">2</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">340</span> INFO <span class="token punctuation">[</span>workerthread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> worker<span class="token operator">-</span><span class="token number">3</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">346</span> INFO <span class="token punctuation">[</span>workerthread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> worker<span class="token operator">-</span><span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>其中logging模块的basicConfig函数的format中的%(threadName)s就是用来输出当前线程的名称的。</p><blockquote><p>线程可以重名, 线程名并不是线程的唯一标识，但是通常应该避免线程重名，通常的处理手段是加前缀</p></blockquote><h3 id="daemon"><a href="#daemon" class="headerlink" title="daemon"></a>daemon</h3><p><strong>Daemon：守护</strong></p><p>和Daemon线程相对应的还有Non-Daemon线程，在此Thread初始化函数中的daemon参数即表示线程是否是Daemon线程。</p><ul><li>Daemon线程：会伴随主线程结束而结束（可以理解为主线程结束，守护线程结束）</li><li>Non-Daemon线程：不会随着主线程结束而结束，主线程需要等待Non-Daemon结束</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logging
<span class="token keyword">import</span> time
<span class="token keyword">import</span> threading

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'starting'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'stopping'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'starting'</span><span class="token punctuation">)</span>
    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker1'</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker2'</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'stopping'</span><span class="token punctuation">)</span>

<span class="token comment"># 输出</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">06</span><span class="token punctuation">,</span><span class="token number">404</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> starting
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">06</span><span class="token punctuation">,</span><span class="token number">436</span> INFO <span class="token punctuation">[</span>worker1<span class="token punctuation">]</span> starting
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">07</span><span class="token punctuation">,</span><span class="token number">492</span> INFO <span class="token punctuation">[</span>worker2<span class="token punctuation">]</span> starting
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">07</span><span class="token punctuation">,</span><span class="token number">492</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> stopping  <span class="token comment"># 主线程执行完成</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">439</span> INFO <span class="token punctuation">[</span>worker1<span class="token punctuation">]</span> stopping  <span class="token comment"># 主线程执行完成之后会等Non-Daemon线程执行完成，但是并不会等Daemon线程执行完成，即Daemon线程会随着主线程执行完成而释放</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="Thread-join"><a href="#Thread-join" class="headerlink" title="Thread.join()"></a>Thread.join()</h3><p>如果想等Daemon线程执行完成之后主线程再退出，可以使用线程对象的<code>join()</code>方法</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logging
<span class="token keyword">import</span> time
<span class="token keyword">import</span> threading

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'starting'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'stopping'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'starting'</span><span class="token punctuation">)</span>
    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker1'</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker2'</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'stopping'</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 输出</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">07</span><span class="token punctuation">,</span><span class="token number">217</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> starting
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">07</span><span class="token punctuation">,</span><span class="token number">243</span> INFO <span class="token punctuation">[</span>worker1<span class="token punctuation">]</span> starting
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">245</span> INFO <span class="token punctuation">[</span>worker2<span class="token punctuation">]</span> starting
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">246</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> stopping
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">09</span><span class="token punctuation">,</span><span class="token number">243</span> INFO <span class="token punctuation">[</span>worker1<span class="token punctuation">]</span> stopping
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">248</span> INFO <span class="token punctuation">[</span>worker2<span class="token punctuation">]</span> stopping<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>使用join函数只有主线程就需要等待Daemon线程执行完成在推出。</p><p>join函数的原型：<code>join(self, timeout=None)</code></p><p>join方法会阻塞直到线程退出或者超时, timeout 是可选的，如果不设置timeout， 会一直等待线程退出。如果设置了timeout，会在超时之后退出或者线程执行完成退出。</p><p>因为join函数总是返回None，因此在超时时间到达之后如果要知道线程是否还是存活的，可以调用is_alive()方法判断线程是否存活。</p><h2 id="threading常用方法"><a href="#threading常用方法" class="headerlink" title="threading常用方法"></a>threading常用方法</h2><h3 id="enumerate"><a href="#enumerate" class="headerlink" title="enumerate()"></a>enumerate()</h3><p>列出当前所有的<strong>存活</strong>的线程</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> threading<span class="token punctuation">.</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread<span class="token punctuation">,</span> started <span class="token number">140209670301504</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Thread<span class="token punctuation">(</span>worker1<span class="token punctuation">,</span> started <span class="token number">140209545410304</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Thread<span class="token punctuation">(</span>worker2<span class="token punctuation">,</span> started daemon <span class="token number">140209537017600</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><h3 id="local"><a href="#local" class="headerlink" title="local()"></a>local()</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logging
<span class="token keyword">import</span> threading

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

ctx <span class="token operator">=</span> threading<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token punctuation">)</span>
ctx<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token number">5</span>
data <span class="token operator">=</span> <span class="token string">'a'</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

worker<span class="token punctuation">(</span><span class="token punctuation">)</span>
threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 输出</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">02</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">102</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> a
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">02</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">113</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> <span class="token number">5</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">02</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">119</span> INFO <span class="token punctuation">[</span>Thread<span class="token operator">-</span><span class="token number">34</span><span class="token punctuation">]</span> a
Exception <span class="token keyword">in</span> thread Thread<span class="token operator">-</span><span class="token number">34</span><span class="token punctuation">:</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"/home/clg/.pyenv/versions/3.5.2/lib/python3.5/threading.py"</span><span class="token punctuation">,</span> line <span class="token number">914</span><span class="token punctuation">,</span> <span class="token keyword">in</span> _bootstrap_inner
    self<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
  File <span class="token string">"/home/clg/.pyenv/versions/3.5.2/lib/python3.5/threading.py"</span><span class="token punctuation">,</span> line <span class="token number">862</span><span class="token punctuation">,</span> <span class="token keyword">in</span> run
    self<span class="token punctuation">.</span>_target<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>_args<span class="token punctuation">,</span> <span class="token operator">**</span>self<span class="token punctuation">.</span>_kwargs<span class="token punctuation">)</span>
  File <span class="token string">"&lt;ipython-input-28-5395bd925d87>"</span><span class="token punctuation">,</span> line <span class="token number">7</span><span class="token punctuation">,</span> <span class="token keyword">in</span> worker
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
AttributeError<span class="token punctuation">:</span> <span class="token string">'_thread._local'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'data'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>线程共享内存、状态和资源。但是thread模块的local类的对象的属性， 只在当前线程可见。</p><h2 id="Thread类的派生"><a href="#Thread类的派生" class="headerlink" title="Thread类的派生"></a>Thread类的派生</h2><p>Python中可以通过继承 <code>Thread</code> 类并重写 <code>run</code> 方法来编写多线程的逻辑，此时逻辑函数就是run。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">mythread</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'mythread run'</span><span class="token punctuation">)</span>

t <span class="token operator">=</span> mythread<span class="token punctuation">(</span><span class="token punctuation">)</span>
t<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 输出mythread run</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 输出mythread run</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>通过继承方式派生而来的子类对象可以同时执行start方法和run方法，结果是一样的，都是执行子类的run方法。但是非继承的方式不能同时使用start方法和run方法，会报错。</p><p><strong>派生时逻辑函数的参数传递</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">mythread</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 需要调用父类的初始化方法初始化</span>
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'mythread run'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kwargs<span class="token punctuation">)</span>

t <span class="token operator">=</span> mythread<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> a<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 输出mythread run (1, 2, 3) &#123;'a': 'b'&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="Timer类"><a href="#Timer类" class="headerlink" title="Timer类"></a>Timer类</h2><p>Timer类：Thread类的派生类，也在threading模块中。意为定时器，用作线程的延迟执行。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">help</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Timer<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>Timer类的初始化方法：<code>__init__(self, interval, function, args=None, kwargs=None)</code></p><ul><li>interval：时间间隔，即几秒之后开始执行function</li><li>function：线程执行的逻辑函数</li><li>args：位置参数</li><li>kwargs：关键字参数</li></ul><p><strong>代码</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'worker running'</span><span class="token punctuation">)</span>

t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Timer<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> function<span class="token operator">=</span>worker<span class="token punctuation">)</span>
t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Timer<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> function<span class="token operator">=</span>worker<span class="token punctuation">)</span>
t1<span class="token punctuation">.</span>setName<span class="token punctuation">(</span><span class="token string">'t1'</span><span class="token punctuation">)</span>
t2<span class="token punctuation">.</span>setName<span class="token punctuation">(</span><span class="token string">'t2'</span><span class="token punctuation">)</span>
logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'canceling &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
t1<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 2s之后仍然可以取消t1</span>
logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>

<span class="token comment"># 输出</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">19</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">801</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> start
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">19</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">811</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> canceling t1
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">19</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">819</span> INFO <span class="token punctuation">[</span>MainThread<span class="token punctuation">]</span> end
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">19</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">808</span> INFO <span class="token punctuation">[</span>t2<span class="token punctuation">]</span> worker running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>**Timer.cancel()**：取消仍然存活的定时器，如果定时器已经开始执行function，则无法取消。</p><p>**Timer.setDaemon(True)**：设置定时器为守护线程</p><h1 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h1><p>当使用多个线程来访问同一个数据时，会经常出现资源争用等线程安全问题(比如多个线程都在操作同一数据导致数据不一致)，这时候我们就可以使用一些同步技术来解决这类问题。比如Event，Lock，Condition，Barrier，Semaphore等等。</p><h2 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h2><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">help</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Event<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>Event对象内置一个标志，这个标志可以由**set()<strong>方法和</strong>clear()<strong>方法设定。线程可以使用</strong>wait()**方法进行阻塞等待，知道Event对象内置标志被set。</p><ol><li>**clear(self)**：设置内置标志为False</li><li>**set(self)**：设置内置标志为True</li><li>**wait(self, timeout&#x3D;None)**：开始阻塞，直到内置标志被设置为True（即wait会阻塞线程直到set方法被调用或者超时）</li><li>**is_set(self)**：当且仅当内置标志为True的时候返回True</li></ol><p>代码</p><p>以下代码实现的逻辑是：一个boss和五个睡觉工人，只要有一个工人完成了睡觉任务，那么就唤醒boss和其他工人。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> datetime
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> random

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>s<span class="token punctuation">)</span>  <span class="token comment"># wait方法而不使用sleep方法，可以让其他工人收到通知后不再等待</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'sleep &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
    event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">boss</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span>threading<span class="token punctuation">.</span>Event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
    end <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'that boss exit takes &#123;&#125;s'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>boss<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'boss'</span><span class="token punctuation">)</span>
    b<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>执行start()方法，测试结果</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">195</span> INFO <span class="token punctuation">[</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> sleep <span class="token number">1</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">198</span> INFO <span class="token punctuation">[</span>boss<span class="token punctuation">]</span> that boss exit takes <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">.</span>004954s
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">199</span> INFO <span class="token punctuation">[</span>worker<span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">]</span> sleep <span class="token number">2</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">199</span> INFO <span class="token punctuation">[</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> sleep <span class="token number">3</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">199</span> INFO <span class="token punctuation">[</span>worker<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> sleep <span class="token number">2</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">198</span> INFO <span class="token punctuation">[</span>worker<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> sleep <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>可以看到：worker-2退出之后，boss和另外四个worker也瞬间就退出了。所以event对象的内置状态被set之后，相关线程就不再wait了。</p><ul><li>event：在线程之间发送信号，通常用于某个线程需要等待其他线程处理完成某些动作之后才能启动</li></ul><p><strong>wait()方法的timeout参数</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'run run run'</span><span class="token punctuation">)</span>

event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 输出</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">275</span> INFO <span class="token punctuation">[</span>Thread<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> run run run
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">277</span> INFO <span class="token punctuation">[</span>Thread<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> run run run
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">281</span> INFO <span class="token punctuation">[</span>Thread<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> run run run
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">21</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">284</span> INFO <span class="token punctuation">[</span>Thread<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> run run run
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>程序每隔3s就会输出一次结果，直到执行set()方法才会停止。因此我们可以写一个定时器（类似于Thread类的派生类Timer）。</p><p><strong>代码</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> interval<span class="token punctuation">,</span> function<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>interval <span class="token operator">=</span> interval
        self<span class="token punctuation">.</span>function <span class="token operator">=</span> function
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs
        self<span class="token punctuation">.</span>event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>__target<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">=</span>args<span class="token punctuation">,</span> kwargs<span class="token operator">=</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__target</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>self<span class="token punctuation">.</span>interval<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>function

    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">cancel</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'run-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">)</span>

t <span class="token operator">=</span> Timer<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> <span class="token string">'hahaha'</span><span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 输出2017-03-21 22:14:59,645 INFO [Thread-20] run-hahaha</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>延迟5s之后执行了逻辑函数，也可以使用cancel函数取消。（<strong>要注意参数的传递，此处Timer初始化不能使用关键字参数</strong>）</p><h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><p>event是用来同步线程之间的操作的，但是如果要控制共享资源的访问那就需要用到锁机制了，在Python标准库中的实现就是内置的lock类。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">help</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Lock<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>**threading.Lock()**函数会创建一个lock类的对象。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">help</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>锁对象是一个同步原语（synchronization primitive），lock对象主要有以下三个方法：</p><ol><li>acquire()： acquire(blocking&#x3D;True, timeout&#x3D;-1) -&gt; bool 获得锁（即锁定锁）。成功获得锁返回True，没有获得锁则返回False。</li><li>release()： release() 释放锁</li><li>locked()： locked() -&gt; bool 检查锁是否被锁住</li></ol><p><strong>代码</strong></p><p>以下代码实现了在多个进程同时对资源进行访问时，进行加锁和解锁的操作，保证加减操作和赋值操作组合之后的原子性。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Counter</span><span class="token punctuation">:</span>  <span class="token comment"># 计时器有加减方法，都会修改value值，因此都需要加锁处理</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> start
        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">inc</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 需要用finally语句保证锁一定会被释放，否则资源永远不可访问</span>

    <span class="token keyword">def</span> <span class="token function">dec</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token number">1</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">inc_worker</span><span class="token punctuation">(</span>c<span class="token punctuation">:</span> Counter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pause <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'sleeping-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>pause<span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>pause<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'cur_value:&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dec_worker</span><span class="token punctuation">(</span>c<span class="token punctuation">:</span> Counter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pause <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'sleeping-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>pause<span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>pause<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>dec<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'cur_value:&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

c <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>inc_worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'inc_worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>dec_worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'dec_worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>测试输出</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">2017-03-21 23:17:44,761 INFO [inc_worker-0] sleeping-0.6542416949220327
2017-03-21 23:17:44,766 INFO [inc_worker-1] sleeping-0.48615543229897873
2017-03-21 23:17:44,771 INFO [dec_worker-0] sleeping-0.12355589507242459
2017-03-21 23:17:44,776 INFO [dec_worker-1] sleeping-0.5276710391905681
2017-03-21 23:17:44,784 INFO [dec_worker-2] sleeping-0.5546251407611247
2017-03-21 23:17:44,900 INFO [dec_worker-0] cur_value:-1
2017-03-21 23:17:45,258 INFO [inc_worker-1] cur_value:0
2017-03-21 23:17:45,312 INFO [dec_worker-1] cur_value:-1
2017-03-21 23:17:45,351 INFO [dec_worker-2] cur_value:-2
2017-03-21 23:17:45,421 INFO [inc_worker-0] cur_value:-1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>可见，各项操作之间保持相互原子性，没有出现干扰。</p><p>因为lock类实现了<code>__enter__</code>和<code>__exit__</code>两个魔术方法，因此支持上下文管理器，可以修改以上Counter类的实现方法如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Counter</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> start
        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">inc</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">dec</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>即使用上下文管理器来代替<code>try...finally...</code>语句，测试输出应该以以上结果一致。</p><p><strong>acquire方法的blocking参数</strong></p><p>当blocking&#x3D;True时，A线程中执行了lock.acquire()方法之后并且没有执行到lock.release()方法，如果在B线程中再次执行lock.acquire()方法，则B线程阻塞。</p><ul><li>正如以上代码实现，当有n个线程需要修改一个共享资源的时候，其他线程在获取锁之前都处于阻塞状态。（python的阻塞都会让出cpu的时间片，因此不是忙等待）</li></ul><p>当blocking&#x3D;Fasle时，A线程中执行了lock.acquire()方法之后并且没有执行到lock.release()方法，如果在B线程中再次执行lock.acquire()方法，则B线程不会阻塞，并且acquire函数返回False。</p><p><strong>acquire方法的timeout参数</strong></p><p>当blocking&#x3D;True并且timeout&gt;0时，acquire会一直阻塞到超时或者锁被释放。</p><p><strong>acquire(0)的参数传递</strong></p><p>模拟acquire方法的默认参数，编写一下函数进行模拟参数传递的过程：</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">print1</span><span class="token punctuation">(</span>blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>blocking<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>

print1<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 输出0 -1</span>
print1<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 输出10 -1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>可见第一个位置参数，替代了blocking。也就是说lock.acquire(0)等效于lock.acquire(blocking&#x3D;False)</p><h2 id="RLock"><a href="#RLock" class="headerlink" title="RLock"></a>RLock</h2><p>正常的lock对象是不能多次调用<code>acquire</code>的，但是可重用锁<code>RLock</code>可以多次调用 <code>acquire</code> 而不阻塞，而且 <code>release</code> 时也要执行和 <code>acquire</code> 一样的次数。</p><h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>除了Event对象之外，线程同步还可以使用条件同步机制Condition。一类线程等待特定条件，而另一类线程发出特定条件满足的信号。</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; help(threading.Condition)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>在Condition的帮助中有以下几个方法：</p><ul><li>初始化方法：**init(self, lock&#x3D;None)**。如果给定了lock参数，那么必须是Lock或者Rlock对象，并且被当做底层锁来使用。如果没有指定，那么会创建一个RLock对象的锁，也被当做底层锁来使用。</li><li>实现了<code>__enter__</code>和<code>__exit__</code>方法，支持上下文管理器。</li><li>notify(self, n&#x3D;1)：唤醒一个或多个在当前Condition上等待的其他线程，如果此方法的调用线程没有获得锁，那么在调用的时候就会报错RuntimeError</li><li>notify_all(self)：唤醒所有线程</li><li>wait(self, timeout&#x3D;None)：一直等待着知道被notifyed或者发生超时</li></ul><p><strong>实例代码</strong></p><p>以下代码实现的是：有一个生产者线程，会生产若干次，每次生产结束后需要通知所有的消费者线程来消费，因此下面代码使用的是notify_all方法。</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> random
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Producer_Consumer_Model</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 用来控制消费者退出</span>
        self<span class="token punctuation">.</span>condition <span class="token operator">=</span> threading<span class="token punctuation">.</span>Condition<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>condition<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 一直等待直到收到生产者通知notify_all</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>  <span class="token comment"># 收到通知之后，开始执行消费者的业务逻辑部分</span>

    <span class="token keyword">def</span> <span class="token function">Producer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 每个生产者生产4次</span>
            data <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>condition<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>data <span class="token operator">=</span> data  <span class="token comment"># 写入成功就表示生产成功，因此需要在此加锁并且能够通知消费者线程去消费，因此选择使用condition来处理</span>
                self<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>notify_all<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 生产成功之后通知所有的消费者去消费</span>
            self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 没生产一次等待1s</span>
        self<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 所有的生产完成之后通知消费者退出</span>

m <span class="token operator">=</span> Producer_Consumer_Model<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>m<span class="token punctuation">.</span>Consumer<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Consumer-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>m<span class="token punctuation">.</span>Producer<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Producer'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>测试结果（一个生产者，三个消费者）</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">2017-03-22 22:07:42,875 INFO [Producer] 16
2017-03-22 22:07:42,883 INFO [Consumer-0] 16
2017-03-22 22:07:42,890 INFO [Consumer-2] 16
2017-03-22 22:07:42,894 INFO [Consumer-1] 16
2017-03-22 22:07:43,884 INFO [Producer] 76
2017-03-22 22:07:43,888 INFO [Consumer-0] 76
2017-03-22 22:07:43,895 INFO [Consumer-2] 76
2017-03-22 22:07:43,898 INFO [Consumer-1] 76
2017-03-22 22:07:44,889 INFO [Producer] 31
2017-03-22 22:07:44,891 INFO [Consumer-0] 31
2017-03-22 22:07:44,911 INFO [Consumer-2] 31
2017-03-22 22:07:44,913 INFO [Consumer-1] 31
2017-03-22 22:07:45,892 INFO [Producer] 17
2017-03-22 22:07:45,894 INFO [Consumer-0] 17
2017-03-22 22:07:45,907 INFO [Consumer-2] 17
2017-03-22 22:07:45,910 INFO [Consumer-1] 17<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>可见，生产者每生产一次，所有的消费者就会去消费。如果想控制每次生产之后通知几个消费者来消费，那么就可以使用notify方法，指定消费者线程个数。</p><p>代码如下</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> random
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Producer_Consumer_Model</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 用来控制消费者退出</span>
        self<span class="token punctuation">.</span>condition <span class="token operator">=</span> threading<span class="token punctuation">.</span>Condition<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>condition<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 一直等待直到收到生产者通知notify_all</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>  <span class="token comment"># 收到通知之后，开始执行消费者的业务逻辑部分</span>

    <span class="token keyword">def</span> <span class="token function">Producer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 每个生产者生产4次</span>
            data <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>condition<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>data <span class="token operator">=</span> data  <span class="token comment"># 写入成功就表示生产成功，因此需要在此加锁并且能够通知消费者线程去消费，因此选择使用condition来处理</span>
                self<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 生产成功之后通知所有的消费者去消费</span>
            self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 没生产一次等待1s</span>
        self<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 所有的生产完成之后通知消费者退出</span>

m <span class="token operator">=</span> Producer_Consumer_Model<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>m<span class="token punctuation">.</span>Consumer<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Consumer-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>m<span class="token punctuation">.</span>Producer<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Producer'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>测试结果（一个生产者，三个消费者，每次生产之后只通知一个消费者去消费）</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">2017-03-22 22:24:52,933 INFO [Producer] 11
2017-03-22 22:24:52,948 INFO [Consumer-0] 11
2017-03-22 22:24:53,949 INFO [Producer] 47
2017-03-22 22:24:53,967 INFO [Consumer-1] 47
2017-03-22 22:24:54,967 INFO [Producer] 14
2017-03-22 22:24:54,983 INFO [Consumer-2] 14
2017-03-22 22:24:55,986 INFO [Producer] 54
2017-03-22 22:24:55,993 INFO [Consumer-0] 54<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><blockquote><ol><li>Condition 通常用于生产者消费者模式， 生产者生产消息之后， 使用notify 或者 notify_all 通知消费者消费。</li><li>消费者使用wait方法阻塞等待生产者通知</li><li>notify通知指定个wait的线程， notify_all通知所有的wait线程</li><li>无论notify&#x2F;notify_all还是wait 都必须先acqurie， 完成后必须确保release， 通常使用with语法</li></ol></blockquote><h2 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h2><p>Barrier类存在于threading模块中，中文可以翻译成栅栏</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">help</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Barrier<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>可以看到Barrier的主要方法和属性：</p><ul><li><code>__init__(self, parties, action=None, timeout=None)</code>：初始化方法，创建一个Barrier<ul><li><code>parties</code>：所有参与的线程的数量</li><li><code>action</code>：所有的线程都wait之后并且在线程释放之前就会执行这个action函数，相当于集结之后要做的事情。</li><li><code>timeout</code>：相当于给需要等待的每个线程的wait方法加上timeout参数，超时则barrier不再生效</li></ul></li><li><code>abort(self)</code>：将Barrier设置成broken状态</li><li><code>reset(self)</code>：将Barrier重置为最初状态</li><li><code>wait(self, timeout=None)</code>：在Barrier前等待，返回在Barrier前等待的下标，从0到parties-1</li><li><code>broken</code>：如果Barrier处于broken状态则返回True</li><li><code>n_waiting</code>：当前已经在Barrier处等待的线程的数量</li><li><code>parties</code>：需要在Barrier处等待的线程的数量</li></ul><p><strong>示例代码</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

barrier <span class="token operator">=</span> threading<span class="token punctuation">.</span>Barrier<span class="token punctuation">(</span>parties<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>barrier<span class="token punctuation">:</span> threading<span class="token punctuation">.</span>Barrier<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'waiting for barrier with &#123;&#125; others'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>barrier<span class="token punctuation">.</span>n_waiting<span class="token punctuation">)</span><span class="token punctuation">)</span>
    worker_id <span class="token operator">=</span> barrier<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'after barrier &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>worker_id<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>barrier<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>测试结果</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">2017-03-22 23:25:03,992 INFO [worker-0] waiting for barrier with 0 others
2017-03-22 23:25:03,995 INFO [worker-1] waiting for barrier with 1 others
2017-03-22 23:25:03,998 INFO [worker-2] waiting for barrier with 2 others
2017-03-22 23:25:04,001 INFO [worker-2] after barrier 2
2017-03-22 23:25:04,001 INFO [worker-0] after barrier 0
2017-03-22 23:25:04,001 INFO [worker-1] after barrier 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>可见，所有的线程都会一直等待，知道所有的线程都到期了，然后就通过barrier，继续执行后续操作。</p><blockquote><p>Barrier会建立一个控制点，所有参与的线程都会阻塞，直到所有参与的“各方”达到这一点。 它让线程分开启动，然后暂停，直到它们都准备好再继续。因此，这一点可以理解为各个线程的一个集结点。</p></blockquote><p><strong>abort函数的使用</strong></p><p>将Barrier设置成broken状态。所有线程在参与集结过程中，只要执行了barrier.abort方法，那么正在等待的线程都会抛出threading.BrokenBarrierError异常。可以理解为，只要有一个线程确定已经到不了Barrier并且通知了Barrier，那么Barrier就会执行abort方法，通知所有正在wait的线程放弃集结。</p><p><strong>实例代码</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>barrier<span class="token punctuation">:</span> threading<span class="token punctuation">.</span>Barrier<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'waiting for barrier with &#123;&#125; others'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>barrier<span class="token punctuation">.</span>n_waiting<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        worker_id <span class="token operator">=</span> barrier<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> threading<span class="token punctuation">.</span>BrokenBarrierError<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'aborting'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'after barrier &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>worker_id<span class="token punctuation">)</span><span class="token punctuation">)</span>

barrier <span class="token operator">=</span> threading<span class="token punctuation">.</span>Barrier<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 需要等待4个线程</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>barrier<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 3个线程都开始wait</span>
barrier<span class="token punctuation">.</span>abort<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 还有一个线程没有到wait，此时执行abort方法，则所有正在wait的线程都抛出异常</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>测试结果</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">2017-03-22 23:47:43,184 INFO [worker-0] waiting for barrier with 0 others
2017-03-22 23:47:43,192 INFO [worker-1] waiting for barrier with 1 others
2017-03-22 23:47:43,201 INFO [worker-2] waiting for barrier with 2 others
2017-03-22 23:47:43,211 INFO [worker-2] aborting
2017-03-22 23:47:43,207 INFO [worker-1] aborting
2017-03-22 23:47:43,207 INFO [worker-0] aborting<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2><p>Semaphore类存在于threading模块中</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">help</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Semaphore<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>信号量内部管理者一个计数器，这个计数器的值等于release()方法调用的次数减去acquire()方法调用的次数然后再加上初始值value，value默认为1。</p><p>可以看到Semaphore的主要方法：</p><ul><li><code>__init__(self, value=1)</code>：初始化一个信号量，value为内部计数器赋初值，默认为1</li><li><code>acquire(self, blocking=True, timeout=None)</code>：获取信号量，内部计数器减一</li><li><code>release(self)</code>：释放信号量，内部计数器加一</li></ul><p><strong>示例代码</strong></p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> random
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s [%(threadName)s] %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Pool</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>num <span class="token operator">=</span> num
        self<span class="token punctuation">.</span>conns <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_make_connect<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 存放连接</span>
        self<span class="token punctuation">.</span>sem <span class="token operator">=</span> threading<span class="token punctuation">.</span>Semaphore<span class="token punctuation">(</span>num<span class="token punctuation">)</span>  <span class="token comment"># 信号量内部计数器初始为连接数</span>

    <span class="token keyword">def</span> <span class="token function">_make_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 根据连接名称创建连接</span>
        conn <span class="token operator">=</span> <span class="token string">'connect-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> conn

    <span class="token keyword">def</span> <span class="token function">get_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 从连接池获取连接</span>
        self<span class="token punctuation">.</span>sem<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>conns<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">return_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conn<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 将连接conn返还到连接池中</span>
        self<span class="token punctuation">.</span>conns<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sem<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>pool<span class="token punctuation">:</span> Pool<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'starting'</span><span class="token punctuation">)</span>
    conn <span class="token operator">=</span> pool<span class="token punctuation">.</span>get_connect<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 如果获取不到则会阻塞在acquire处</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'get connect &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'takes &#123;&#125;s'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span>return_connect<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'return connect &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>

pool <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 连接池中有两个连接可以使用</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 三个线程使用两个连接开始任务</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'worker-&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>测试结果</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">2017-03-23 00:54:36,056 INFO [worker-0] starting
2017-03-23 00:54:36,062 INFO [worker-0] get connect connect-1
2017-03-23 00:54:36,074 INFO [worker-1] starting
2017-03-23 00:54:36,079 INFO [worker-1] get connect connect-0
2017-03-23 00:54:36,089 INFO [worker-2] starting
2017-03-23 00:54:39,074 INFO [worker-0] takes 3s
2017-03-23 00:54:39,076 INFO [worker-0] return connect connect-1
2017-03-23 00:54:39,076 INFO [worker-2] get connect connect-1
2017-03-23 00:54:39,093 INFO [worker-1] takes 3s
2017-03-23 00:54:39,097 INFO [worker-1] return connect connect-0
2017-03-23 00:54:40,093 INFO [worker-2] takes 1s
2017-03-23 00:54:40,107 INFO [worker-2] return connect connect-1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>这个测试结果显示：三个线程获取连接池中的两个连接，结果出现了一个线程等待其他线程执行完成之后再获取连接的过程。</p><h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><p>Condition线程同步部分用来传递数据的是一个封装在生产者消费者模型中的元素data（正常使用情况下一般封装的都是一个列表，类似与Barrier部分的连接池中的conns列表）。</p><p>Python的queue模块中提供了同步的、线程安全的队列类，包括三种队列：</p><ul><li>FIFO（先入先出)队列Queue</li><li>LIFO（后入先出）队列LifoQueue</li><li>优先级队列PriorityQueue</li></ul><p>这些队列都实现了锁原语，能够在多线程中直接使用。可以使用队列来实现线程间的同步。因此我们可以使用queue模块来替换掉生产者消费者中的全局元素，代码如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">import</span> queue
<span class="token keyword">import</span> threading

<span class="token keyword">class</span> <span class="token class-name">Producer_Consumer_Model</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>q <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">Producer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

m <span class="token operator">=</span> Producer_Consumer_Model<span class="token punctuation">(</span><span class="token punctuation">)</span>
threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>m<span class="token punctuation">.</span>Consumer<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Consumer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>m<span class="token punctuation">.</span>Producer<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Producer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>测试结果</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">2017-03-23 10:11:22,990 INFO [Producer] 26
2017-03-23 10:11:22,993 INFO [Consumer] 26
2017-03-23 10:11:25,993 INFO [Producer] 89
2017-03-23 10:11:26,003 INFO [Consumer] 89
2017-03-23 10:11:29,004 INFO [Producer] 14
2017-03-23 10:11:29,006 INFO [Consumer] 14
2017-03-23 10:11:32,007 INFO [Producer] 17
2017-03-23 10:11:32,009 INFO [Consumer] 17<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>每生产一次，消费者就会消费一次。当消费者线程，读取Queue则调用Queue.get()方法，若Queue为空时消费者线程获取不到内容，就会阻塞在这里，直到成功获取内容。</p><p>##线程同步总结</p><ul><li>Event：主要用于线程之间的事件通知</li><li>Lock,Rlock：主要用于保护共享资源</li><li>Condition：主要用于生产者消费者模型，可以理解为Event和Lock的结合体</li><li>Barrier：同步指定个等待的线程</li><li>Semaphore：主要用于保护资源，和Lock的区别在于可以多个线程访问共享资源，而锁一次只能一个线程访问到共享资源，即锁是value&#x3D;1的信号量</li><li>Queue：使用FIFO队列进行同步，适用于生产者消费者模型</li></ul><h1 id="GIL"><a href="#GIL" class="headerlink" title="GIL"></a>GIL</h1><p>GIL（Global Interpreter Lock）：全局解释器锁</p><p>Python代码的执行由Python 主循环来控制，Python 在设计之初就考虑到要在解释器的主循环中，同时只有一个线程在执行，即在任意时刻，只有一个线程在解释器中运行。对Python 主循环的访问由全局解释器锁（GIL）来控制，正是这个锁能保证同一时刻只有一个线程在运行。</p><p>因此Python多线程程序的执行顺序如下：</p><ol><li>设置GIL</li><li>切换到一个线程去运行</li><li>运行</li><li>结束线程</li><li>解锁GIL</li><li>重复以上步骤</li></ol><p>因此，Python的多线程并没有实现并行，只是实现了并发而已。如果要实现真正的并行，那就需要使用Python的多进程模块multiprocessing（multiprocessing模块的宗旨是像管理线程一样来管理进程）。</p><hr><p>参考资料</p><ol><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://pymotw.com/3/threading/index.html">threading — Manage Concurrent Operations Within a Process</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://yoyzhou.github.io/blog/2013/02/28/python-threads-synchronization-locks/">Python线程同步机制: Locks, RLocks, Semaphores, Conditions, Events和Queues</a></li></ol></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/python/" class="category-chain-item">python</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Python/">#Python</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">#多线程</a> <a href="/tags/threading/">#threading</a></div></div><div class="license-box my-3"><div class="license-title"><div>Python多线程</div><div>https://suncle.me/posts/4097981062/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Suncle Chen</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2017年3月23日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/posts/3541559492/" title="Python网络编程"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Python网络编程</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/1516127351/" title="Python描述器"><span class="hidden-mobile">Python描述器</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><script type="text/javascript">Fluid.utils.loadComments("#comments",(function(){var t=document.documentElement.getAttribute("data-user-color-scheme");t="dark"===t?"github-dark":"github-light",window.UtterancesThemeLight="github-light",window.UtterancesThemeDark="github-dark";var e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","suncle1993/suncle1993.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>