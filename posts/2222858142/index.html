<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/android-chrome-192x192.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Suncle Chen"><meta name="keywords" content=""><meta name="description" content="关于冷热数据备份和恢复的思考数据库：Mysql InnoDB 目标：备份指定数据表指定时间段的全字段数据到数据文件，并删除掉数据库中已备份数据 说明：这里说的数据备份不是灾备，而且通过备份基本不会使用的数据来缓解数据库压力，要求备份的数据是可以恢复的 持久化存储：文本格式的数据文件，存储于oss中 思考：不同表中可能含有多个时间字段，可能的组合如下  update_time create_time"><meta property="og:type" content="article"><meta property="og:title" content="关于冷热数据备份和恢复的思考"><meta property="og:url" content="https://suncle.me/posts/2222858142/index.html"><meta property="og:site_name" content="Suncle"><meta property="og:description" content="关于冷热数据备份和恢复的思考数据库：Mysql InnoDB 目标：备份指定数据表指定时间段的全字段数据到数据文件，并删除掉数据库中已备份数据 说明：这里说的数据备份不是灾备，而且通过备份基本不会使用的数据来缓解数据库压力，要求备份的数据是可以恢复的 持久化存储：文本格式的数据文件，存储于oss中 思考：不同表中可能含有多个时间字段，可能的组合如下  update_time create_time"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2018-01-22T08:28:13.000Z"><meta property="article:modified_time" content="2022-08-26T02:44:02.232Z"><meta property="article:author" content="Suncle Chen"><meta property="article:tag" content="备份"><meta property="article:tag" content="恢复"><meta property="article:tag" content="数据"><meta property="article:tag" content="设计思想"><meta name="twitter:card" content="summary_large_image"><meta name="referrer" content="no-referrer-when-downgrade"><title>关于冷热数据备份和恢复的思考 - Suncle</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"suncle.me",root:"/",version:"1.9.2",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:"41fc030db57d5570dd22f78997dc4a7e",google:"UA-72506112-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Suncle" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Suncle&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/categories/newsletter/"><i class="iconfont icon-mail"></i> 周刊</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" rel="external nofollow noreferrer" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 更多</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签 </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss-fill"></i> RSS</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" rel="external nofollow noreferrer" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/suncle-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">关于冷热数据备份和恢复的思考</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2018-01-22 16:28" pubdate>2018年1月22日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.7k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 39 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="数据库" id="heading-68051bf4aa2743b030984b694628ee9c" role="tab" data-toggle="collapse" href="#collapse-68051bf4aa2743b030984b694628ee9c" aria-expanded="true">数据库 <span class="list-group-count">(26)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-68051bf4aa2743b030984b694628ee9c" role="tabpanel" aria-labelledby="heading-68051bf4aa2743b030984b694628ee9c"><div class="category-post-list"><a href="/posts/1301073950/" title="DBA常用的SQL语句" class="list-group-item list-group-item-action"><span class="category-post">DBA常用的SQL语句</span> </a><a href="/posts/326482037/" title="DBA日常工作和职责" class="list-group-item list-group-item-action"><span class="category-post">DBA日常工作和职责</span> </a><a href="/posts/77751803/" title="Oracle SQL语句分类" class="list-group-item list-group-item-action"><span class="category-post">Oracle SQL语句分类</span> </a><a href="/posts/943732234/" title="Oracle内存结构和后台进程" class="list-group-item list-group-item-action"><span class="category-post">Oracle内存结构和后台进程</span> </a><a href="/posts/1725623659/" title="Oracle字符集检查和修改" class="list-group-item list-group-item-action"><span class="category-post">Oracle字符集检查和修改</span> </a><a href="/posts/1068104890/" title="Oracle数据字典" class="list-group-item list-group-item-action"><span class="category-post">Oracle数据字典</span> </a><a href="/posts/3723584290/" title="Oracle数据库的对象" class="list-group-item list-group-item-action"><span class="category-post">Oracle数据库的对象</span> </a><a href="/posts/2852429327/" title="Oracle数据库的文件以及Oracle体系架构" class="list-group-item list-group-item-action"><span class="category-post">Oracle数据库的文件以及Oracle体系架构</span> </a><a href="/posts/2528944512/" title="Oracle数据结构" class="list-group-item list-group-item-action"><span class="category-post">Oracle数据结构</span> </a><a href="/posts/3325660628/" title="PL/SQL Developer连接本地Oracle 11g 64位数据库" class="list-group-item list-group-item-action"><span class="category-post">PL/SQL Developer连接本地Oracle 11g 64位数据库</span> </a><a href="/posts/2332377615/" title="RAC与DG" class="list-group-item list-group-item-action"><span class="category-post">RAC与DG</span> </a><a href="/posts/4122458799/" title="Rman备份恢复和管理" class="list-group-item list-group-item-action"><span class="category-post">Rman备份恢复和管理</span> </a><a href="/posts/2203031021/" title="oracle的userenv和nls_lang详解" class="list-group-item list-group-item-action"><span class="category-post">oracle的userenv和nls_lang详解</span> </a><a href="/posts/1788341412/" title="plsql" class="list-group-item list-group-item-action"><span class="category-post">plsql</span> </a><a href="/posts/3660988069/" title="sql语句中(+)的作用" class="list-group-item list-group-item-action"><span class="category-post">sql语句中(+)的作用</span> </a><a href="/posts/1407336675/" title="win7x64安装配置Oracle 11g R2数据库" class="list-group-item list-group-item-action"><span class="category-post">win7x64安装配置Oracle 11g R2数据库</span> </a><a href="/posts/3622600928/" title="事务Transaction" class="list-group-item list-group-item-action"><span class="category-post">事务Transaction</span> </a><a href="/posts/2680367260/" title="做一名合格的DBA" class="list-group-item list-group-item-action"><span class="category-post">做一名合格的DBA</span> </a><a href="/posts/2222858142/" title="关于冷热数据备份和恢复的思考" class="list-group-item list-group-item-action active"><span class="category-post">关于冷热数据备份和恢复的思考</span> </a><a href="/posts/1024884206/" title="回滚段undo" class="list-group-item list-group-item-action"><span class="category-post">回滚段undo</span> </a><a href="/posts/197889581/" title="复杂一点的SQL语句" class="list-group-item list-group-item-action"><span class="category-post">复杂一点的SQL语句</span> </a><a href="/posts/113432121/" title="常用Oracle SQL集锦" class="list-group-item list-group-item-action"><span class="category-post">常用Oracle SQL集锦</span> </a><a href="/posts/1381741750/" title="数据库备份和恢复" class="list-group-item list-group-item-action"><span class="category-post">数据库备份和恢复</span> </a><a href="/posts/1415694062/" title="自动存储管理ASM" class="list-group-item list-group-item-action"><span class="category-post">自动存储管理ASM</span> </a><a href="/posts/2300458046/" title="重做日志和日志挖掘" class="list-group-item list-group-item-action"><span class="category-post">重做日志和日志挖掘</span> </a><a href="/posts/482295211/" title="闪回flashback" class="list-group-item list-group-item-action"><span class="category-post">闪回flashback</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">关于冷热数据备份和恢复的思考</h1><div class="markdown-body"><h1 id="关于冷热数据备份和恢复的思考"><a href="#关于冷热数据备份和恢复的思考" class="headerlink" title="关于冷热数据备份和恢复的思考"></a>关于冷热数据备份和恢复的思考</h1><p>数据库：Mysql InnoDB</p><p>目标：备份指定数据表指定时间段的全字段数据到数据文件，并删除掉数据库中已备份数据</p><p>说明：这里说的数据备份不是灾备，而且通过备份基本不会使用的数据来缓解数据库压力，要求备份的数据是可以恢复的</p><p>持久化存储：文本格式的数据文件，存储于oss中</p><p>思考：不同表中可能含有多个时间字段，可能的组合如下</p><ul><li><code>update_time</code></li><li><code>create_time</code> &amp; <code>update_time</code></li><li><code>create_time</code> &amp; <code>update_time</code> &amp; 业务时间（由程序插入，可能是datetime可能是date可能是timestamp）</li></ul><p>一般数据表设计时都会带上创建时间和修改时间。</p><ul><li>数据一般都是快速增长，较少或者几乎不更新，属于记录型的数据</li></ul><span id="more"></span><p>以下数据表都是示例表</p><h1 id="探索replace导致的时间变化"><a href="#探索replace导致的时间变化" class="headerlink" title="探索replace导致的时间变化"></a>探索replace导致的时间变化</h1><p>由于之前的数据库数据插入时，不同项目可能都使用了replace，因此需要看下replace的影响</p><p>创建测试表tb_user</p><p>insert插入数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT INTO `tb_user`(`mail`, `username`, `password`) VALUES(&#x27;572924509@qq.com&#x27;, &#x27;suncle&#x27;, &#x27;123456&#x27;);<br></code></pre></td></tr></table></figure><p>replace更新数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">REPLACE INTO `tb_user`(`mail`, `username`, `password`) VALUES(&#x27;572924509@qq.com&#x27;, &#x27;suncle&#x27;, &#x27;abcdef&#x27;);<br></code></pre></td></tr></table></figure><p>replace操作是先删除已存在的数据然后插入新的数据，因此<code>id</code>，<code>create_time</code>，<code>update_time</code>都变化了。</p><p>另外，当插入数据失败时（比如遇到唯一键冲突），主键id也会自动增大，此处不验证。</p><h1 id="探索insert时自动更新字段的变化"><a href="#探索insert时自动更新字段的变化" class="headerlink" title="探索insert时自动更新字段的变化"></a>探索insert时自动更新字段的变化</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT INTO `tb_user`(`mail`, `username`, `password`, `create_time`, `update_time`) VALUES(&#x27;5729245012@qq.com&#x27;, &#x27;suncle1&#x27;, &#x27;123456&#x27;, &#x27;2018-02-02 00:00:00&#x27;, &#x27;2018-02-02 00:00:01&#x27;);<br></code></pre></td></tr></table></figure><p>create_time和update_time都会自动更新，默认值分别为：</p><ul><li>create_time： CURRENT_TIMESTAMP</li><li>update_time： CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</li></ul><p>指定两个自动更新字段后，该字段的结果为指定值，而不是自动更新的值，即手动插入什么就是什么。</p><h1 id="备份方案列举比较"><a href="#备份方案列举比较" class="headerlink" title="备份方案列举比较"></a>备份方案列举比较</h1><p>从备份的简洁性和恢复的便利性来比较</p><p>关于时间的获取：<strong>程序插入时间，update_time</strong>两者时间取最大值表示这条数据的最后修改时间</p><ul><li><code>create_time</code>，<code>update_time</code>字段都没有索引</li></ul><h2 id="时间维度"><a href="#时间维度" class="headerlink" title="时间维度"></a>时间维度</h2><h3 id="基于主键id"><a href="#基于主键id" class="headerlink" title="基于主键id"></a>基于主键id</h3><h4 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h4><p>查询1000条数据，如果要从指定id开始，则绑定min_id</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM tb_stream_computer_concurrency WHERE id &gt; :min_id LIMIT 1000;<br></code></pre></td></tr></table></figure><p>然后用获取到的最大的id去查询所有时间字段，并通过程序取最大值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT `time`, `create_time`, `update_time` AS max_time FROM tb_stream_computer_concurrency WHERE id = :max_id<br></code></pre></td></tr></table></figure><p>具体步骤：每次1000条数据，没有处理到指定时间则继续循环处理后面1000条，如果最后一条数据最大时间超过指定时间，则基于主键id进行二分查找找到小于指定时间并且最接近指定时间的数据，处理完成。</p><h4 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h4><p>当次备份结束，需要开始clean数据库，可以根据id直接批量删除，直至删除结束</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DELETE FROM tb_stream_computer_concurrency WHERE id &lt; :max_id LIMIT 1000<br></code></pre></td></tr></table></figure><p>为了保证数据一致性，之前处理的数据不能立马删除，因此采用下面的处理方式不合理，速度慢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM tb_stream_computer_concurrency WHERE id &lt; :max_id AND `time` &lt; &#x27;2017-08-01 15:30:00&#x27; AND update_time &lt; &#x27;2017-08-01 15:30:00&#x27;<br></code></pre></td></tr></table></figure><p>假设’2017-08-01 15:30:00’为指定的时间，max_id为最后一次处理的max_id</p><h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><p>优点：</p><ol><li>主键有索引，所有基于id的sql都不会进行全表扫描，速度较快</li><li>使用二分查找的方法毕竟限制时间点能最大程度的满足时间限制的要求</li></ol><p>缺点：</p><ol><li>二分查找时查找到的最终的id对应的时间有多条数据，需要排除掉这几条数据，从尾部开始做一个filter</li><li>此方案适合少更新的数据，对于id小，但是时间大的数据可能会出现误备份</li></ol><h3 id="基于指定时刻"><a href="#基于指定时刻" class="headerlink" title="基于指定时刻"></a>基于指定时刻</h3><p>比如60天，找到指定时刻之前的所有数据中时间最小的数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT MIN(`time`), MIN(`update_time`) FROM `tb_stream_computer_concurrency`<br></code></pre></td></tr></table></figure><p>然后从最小的时间开始按照<strong>基于时间段</strong>的方法批次处理数据（查找sql速度太慢），直到处理到指定时刻</p><h3 id="基于指定时间段"><a href="#基于指定时间段" class="headerlink" title="基于指定时间段"></a>基于指定时间段</h3><p>寻找位于时间段内的数据进行批次备份</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM `tb_stream_computer_concurrency` WHERE `time` &gt; :min_time AND `time` &lt; :max_time AND `id` &gt; :min_id ORDER BY `date_time`,`id` LIMIT 1000<br></code></pre></td></tr></table></figure><p>所有数据备份完成按照时间段进行删除，删除方式如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DELETE FROM `tb_stream_computer_concurrency` WHERE `time` &lt; :max_time LIMIT 100<br></code></pre></td></tr></table></figure><h3 id="基于指定空间阈值"><a href="#基于指定空间阈值" class="headerlink" title="基于指定空间阈值"></a>基于指定空间阈值</h3><p>比如备份mysql数据空间占用的大小指定空间最高阈值之下</p><p>对于阿里云rds可以调用接口判断当前数据库已占用空间大小，也可以使用sql查询数据库表的占用空间</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT DATA_LENGTH+INDEX_LENGTH FROM information_schema.TABLES WHERE TABLE_SCHEMA=&#x27;qk_real_time_data&#x27; AND TABLE_NAME=&#x27;tb_stream_computer_concurrency&#x27;<br></code></pre></td></tr></table></figure><p>查询结果单位为字节Byte，转化为M需要除以2个1024。</p><p>然后按照基于主键id的方式进行备份删除，直至数据表占用空间降到指定阈值以下即可停止当次处理。</p><h2 id="业务层唯一标识维度"><a href="#业务层唯一标识维度" class="headerlink" title="业务层唯一标识维度"></a>业务层唯一标识维度</h2><p>即基于唯一标识live_id，取得最老的一个live_id，然后根据live_id查询所有的指定时间之前的记录，进行备份和清理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT live_id FROM tb_stream_computer_concurrency ORDER BY id LIMIT 1;<br>SELECT * FROM tb_stream_computer_concurrency WHERE live_id=:live_id<br></code></pre></td></tr></table></figure><p>对查询出来的数据进行备份，如果担心数据量过大，可以对查询出来的数据进行limit分批备份清理。此方案的速度较快。</p><h2 id="混合维度"><a href="#混合维度" class="headerlink" title="混合维度"></a>混合维度</h2><p>基于一定时间段内的唯一标识对应的所有记录进行备份（查询时有索引的在前）</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tb_stream_computer_concurrency <span class="hljs-keyword">WHERE</span> live_id=:live_id <span class="hljs-keyword">AND</span> <span class="hljs-built_in">GREATEST</span>(<span class="hljs-symbol">`time`</span>, <span class="hljs-symbol">`create_time`</span>, <span class="hljs-symbol">`update_time`</span>) &gt;= :datetime1 <span class="hljs-keyword">AND</span> <span class="hljs-built_in">GREATEST</span>(<span class="hljs-symbol">`time`</span>, <span class="hljs-symbol">`create_time`</span>, <span class="hljs-symbol">`update_time`</span>) &lt; :datetime2<br></code></pre></td></tr></table></figure><p>如果去掉偏移区间，速度会更快</p><h2 id="备份方案结论"><a href="#备份方案结论" class="headerlink" title="备份方案结论"></a>备份方案结论</h2><ol><li>在各个时间字段没有加索引的情况下使用基于主键id的方式备份数据库数据是最合适的</li><li>在各个时间字段加了索引的情况下可以使用基于时间点和时间段的方式处理，这样程序更简洁，逻辑更清楚</li><li>基于指定空间阈值只有在确实需要此种处理时采取执行，具体底层选择基于什么处理按第一点和第二点分析</li><li>不考虑oss文件数量较多，最推荐的方案是基于业务层的唯一标识，便于精准恢复</li></ol><h1 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h1><p>oss存储时的文件名，备份时的文件名决定恢复时的策略</p><p>主要两种：</p><ul><li>基于时间段恢复数据，可以是按天，周，月为单位</li><li>基于唯一标识信息恢复数据，此处为live_id</li></ul><h2 id="时间维度-1"><a href="#时间维度-1" class="headerlink" title="时间维度"></a>时间维度</h2><p>oss文件名称：OssPrefix&#x2F;EnvName&#x2F;Datetime</p><p>获取指定前缀的所有文件解析即可，如果要做到精确恢复，需要逐个文件下载再分析。</p><h2 id="业务层唯一标识维度-1"><a href="#业务层唯一标识维度-1" class="headerlink" title="业务层唯一标识维度"></a>业务层唯一标识维度</h2><p>在直播业务场景中，直播id即live_id是可以唯一标识一场活动的，因此基于live_id恢复是能达到精准恢复的。当然对于不同的表，如果数据量快速增长，可以肯定都是有业务层的唯一标识的。因此对于不同的表是可以基于唯一标识进行备份恢复的。</p><p>需要确认唯一标识的数据量，因为一个唯一标识就会对应一个oss文件。</p><p>oss文件名称：OssPrefix&#x2F;EnvName&#x2F;UniqueKey&#x2F;UUID</p><p>具体的uuid可以随意指定，具有唯一标示性即可，建议使用当前datetime和32位的uuid组成即可</p><p>如果业务层唯一标识在不同的环境中也是全局唯一的，那么就可以省掉EnvName这个前缀</p><p>如果需要恢复指定时间段时的数据则需要遍历所有的UniqueKey并匹配UUID，但是由于恢复操作较少，对于oss和数据库的操作都不会太多，因此恢复指定时间段的数据也是可以实现的</p><h2 id="混合维度-1"><a href="#混合维度-1" class="headerlink" title="混合维度"></a>混合维度</h2><p>oss文件命名时同时考虑时间段和唯一标识，时间段量小，因此时间段筛选在前，唯一标识在后</p><p>oss文件名称：OssPrefix&#x2F;EnvName&#x2F;Datetime&#x2F;UniqueKey&#x2F;UUID</p><p>恢复指定id时需要遍历所有的时间前缀，然后找对应的UniqueKey</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>兼顾到数据备份和基于唯一标识恢复基于时间恢复的精确度，因此本次采用业务层唯一标识维度和时间维度（按天为段）混合的方式，主要优势在于基于时间恢复可以很快，基于唯一标识的恢复虽然复杂一点但是也较快</p><p>（即需要在oss文件名中体现时间段和唯一标识，时间段长度固定，用结束时间表示）</p><p>最终的执行方式：</p><ul><li>备份自动执行</li><li>恢复提供按业务唯一标识和时间段，分别提供接口</li></ul><p>后续如果恢复要求较高，改用外部表的方式重写</p><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ol><li>对于mysql千万级别的表，如果冷热数据明显，则可以直接使用本篇文章中讨论的备份方法备份到oss上</li><li>除了直接全部持久化冷数据的方式之外，可以采用外部表的方案，比如<strong>冷数据转存RDS PostgreSQL版 + OSS</strong>， 此方案在恢复时优于全冷备的方式，但结构也较为复杂，但在恢复时较为迅速</li><li>除分库分表，分区表，外部表外还有历史拉链表和闪回数据归档FDA等方式（饮水大神介绍）</li></ol><p>参考：</p><ol><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://yq.aliyun.com/articles/66856">云栖社区-云上如何做冷热数据分离</a></li></ol></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">数据库</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%A4%87%E4%BB%BD/">#备份</a> <a href="/tags/%E6%81%A2%E5%A4%8D/">#恢复</a> <a href="/tags/%E6%95%B0%E6%8D%AE/">#数据</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/">#设计思想</a></div></div><div class="license-box my-3"><div class="license-title"><div>关于冷热数据备份和恢复的思考</div><div>https://suncle.me/posts/2222858142/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Suncle Chen</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2018年1月22日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/posts/3013774428/" title="Erlang测试全集(挖坑)"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Erlang测试全集(挖坑)</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/3256341395/" title="基于消息传递的并发模型"><span class="hidden-mobile">基于消息传递的并发模型</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><script type="text/javascript">Fluid.utils.loadComments("#comments",(function(){var t=document.documentElement.getAttribute("data-user-color-scheme");t="dark"===t?"github-dark":"github-light",window.UtterancesThemeLight="github-light",window.UtterancesThemeDark="github-dark";var e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","suncle1993/suncle1993.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>